<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agendamento - Vinicius Ravagnani</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animações e Transições */
        .view-section { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease-out, transform 0.3s ease-out; }
        .view-section.active { display: block; opacity: 1; transform: translateY(0); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 50; display: flex; align-items: flex-end; justify-content: center; }
        .modal-overlay.hidden { display: none; }
        .modal-content { background: white; width: 100%; max-width: 450px; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; overflow-y: auto; }
        @media(min-width: 640px) { .modal-overlay { align-items: center; } .modal-content { border-radius: 20px; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Estilos Específicos */
        .time-slot { transition: all 0.2s; border: 1px solid #E5E7EB; }
        .time-slot.selected { background-color: #22c55e; color: white; border-color: #22c55e; box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3); }
        .time-slot.booked { background-color: #F3F4F6; color: #9CA3AF; text-decoration: line-through; pointer-events: none; border-color: transparent; }
        
        .nav-tab { white-space: nowrap; padding: 12px 16px; font-size: 0.85rem; font-weight: 600; color: #64748B; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .nav-tab.active { color: #0D9488; border-bottom-color: #0D9488; }
        
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.9rem; position: relative; cursor: pointer; transition: all 0.2s; }
        .calendar-day:hover { background-color: #F1F5F9; }
        .calendar-day.has-slots { font-weight: 700; color: #0F172A; }
        .calendar-day.has-slots::after { content: ''; width: 4px; height: 4px; background: #22c55e; border-radius: 50%; position: absolute; bottom: 6px; }
        .calendar-day.full { color: #EF4444; }
        .calendar-day.selected { background-color: #0D9488; color: white; box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3); }
        .calendar-day.selected::after { background: white; }

        .input-field { width: 100%; background: #F8FAFC; border: 1px solid #E2E8F0; padding: 12px; border-radius: 12px; font-size: 0.9rem; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #0D9488; background: white; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
        
        .fab { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 40; transition: transform 0.2s; }
        .fab:active { transform: scale(0.95); }
    </style>
</head>
<body class="text-gray-800 antialiased pb-safe">

    <div id="view-profile" class="view-section active max-w-md mx-auto bg-white min-h-screen shadow-2xl relative z-10">
        <div class="h-32 bg-gradient-to-br from-blue-600 to-indigo-600 relative">
            <button onclick="checkAdmin()" class="absolute top-4 right-4 text-white/50 hover:text-white p-2"><i class="fa-solid fa-lock"></i></button>
        </div>
        <div class="px-6 -mt-16 relative">
            <div class="w-32 h-32 rounded-full border-4 border-white shadow-lg bg-white overflow-hidden">
                <img src="https://ui-avatars.com/api/?name=Vinicius+Ravagnani&background=0D8ABC&color=fff&size=256" alt="Vinicius" class="w-full h-full object-cover">
            </div>
            <div class="mt-4 flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Vinicius Ravagnani</h1>
                    <p class="text-sm text-blue-600 font-medium">Psicólogo Clínico &bull; CRP 06/12345</p>
                </div>
                <div class="text-right bg-blue-50 px-3 py-1 rounded-lg">
                    <p class="text-lg font-bold text-blue-700">R$ 150</p>
                    <p class="text-[10px] text-blue-400 font-bold uppercase">Sessão 50min</p>
                </div>
            </div>
            
            <div class="mt-6 space-y-6">
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Especialidades</h3>
                    <div class="flex flex-wrap gap-2">
                        <span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">Terapia Cognitivo-Comportamental</span>
                        <span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">Ansiedade</span>
                        <span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">Autoconhecimento</span>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Sobre</h3>
                    <p class="text-sm text-gray-600 leading-relaxed">
                        Olá! Sou o Vinicius. Meu objetivo é oferecer um espaço seguro e acolhedor para que você possa explorar seus sentimentos e desenvolver ferramentas para lidar com os desafios da vida.
                    </p>
                </div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-md border-t border-gray-100 max-w-md mx-auto">
            <button onclick="navigateTo('view-client-calendar')" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-[0.98] flex justify-center items-center gap-2">
                <i class="fa-regular fa-calendar"></i> Agendar Sessão
            </button>
        </div>
    </div>

    <div id="view-client-calendar" class="view-section max-w-md mx-auto bg-gray-50 min-h-screen relative">
        <div class="bg-white px-4 py-4 shadow-sm sticky top-0 z-20 flex items-center gap-4">
            <button onclick="navigateTo('view-profile')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-arrow-left"></i></button>
            <h2 class="font-bold text-gray-800 text-lg">Escolha um horário</h2>
        </div>

        <div class="p-4">
            <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-700" id="client-month-display">Janeiro</h3>
                    <div class="flex gap-2">
                         <button onclick="clientChangeDate(-1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                         <button onclick="clientChangeDate(1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                    </div>
                </div>
                <div id="client-date-scroll" class="flex overflow-x-auto gap-3 pb-2 no-scrollbar snap-x">
                    </div>
            </div>

            <div id="client-slots-container">
                <div id="client-slots-grid" class="grid grid-cols-3 gap-3">
                    </div>
                <div id="client-empty-state" class="hidden text-center py-10">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400">
                        <i class="fa-regular fa-calendar-xmark text-2xl"></i>
                    </div>
                    <p class="text-gray-500 text-sm">Nenhum horário disponível nesta data.</p>
                </div>
            </div>
        </div>

        <div id="client-confirm-bar" class="fixed bottom-0 left-0 right-0 bg-white p-4 border-t border-gray-100 max-w-md mx-auto transform translate-y-full transition-transform duration-300 shadow-[0_-4px_20px_rgba(0,0,0,0.1)]">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <p class="text-xs text-gray-500 font-medium uppercase">Horário Selecionado</p>
                    <p id="client-selected-info" class="text-sm font-bold text-gray-900">--/-- às --:--</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500 font-medium uppercase">Valor</p>
                    <p class="text-sm font-bold text-blue-600">R$ 150,00</p>
                </div>
            </div>
            <button onclick="openBookingModal()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-600/20">
                Confirmar Agendamento
            </button>
        </div>
    </div>

    <div id="view-admin" class="view-section max-w-md mx-auto bg-slate-50 min-h-screen pb-24">
        <div class="bg-white px-5 py-4 shadow-sm sticky top-0 z-30 flex justify-between items-center">
            <div>
                <h2 class="font-bold text-lg text-slate-800">Painel <span class="text-teal-600">PsiPro</span></h2>
            </div>
            <button onclick="navigateTo('view-profile')" class="text-xs font-semibold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full hover:bg-slate-200">
                <i class="fa-solid fa-arrow-right-from-bracket mr-1"></i> Sair
            </button>
        </div>

        <div class="bg-white border-b border-slate-100 flex overflow-x-auto sticky top-[60px] z-20 hide-scrollbar px-2">
            <button onclick="switchTab('dashboard')" class="nav-tab active" data-tab="dashboard">Visão Geral</button>
            <button onclick="switchTab('calendar')" class="nav-tab" data-tab="calendar">Agenda</button>
            <button onclick="switchTab('clients')" class="nav-tab" data-tab="clients">Pacientes</button>
            <button onclick="switchTab('financial')" class="nav-tab" data-tab="financial">Financeiro</button>
            <button onclick="switchTab('settings')" class="nav-tab" data-tab="settings">Config</button>
        </div>

        <div class="p-4">
            
            <div id="tab-dashboard" class="tab-content block">
                <div class="bg-gradient-to-r from-teal-600 to-teal-500 text-white rounded-2xl p-5 shadow-lg shadow-teal-500/20 mb-6 relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 bg-white/20 w-32 h-32 rounded-full blur-2xl"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-teal-50 font-medium text-xs uppercase tracking-wider">Próxima Sessão</h3>
                            <span id="dash-next-badge" class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold">HOJE</span>
                        </div>
                        <div id="dash-next-content">
                            <p id="dash-next-time" class="text-3xl font-bold mb-1">--:--</p>
                            <p id="dash-next-client" class="text-teal-50 font-medium text-lg truncate">Nenhum agendamento</p>
                            <div class="mt-4 flex gap-2">
                                <button onclick="sendQuickMsg()" class="bg-white text-teal-700 text-xs font-bold px-3 py-2 rounded-lg flex-1 shadow-sm active:scale-95 transition"><i class="fa-brands fa-whatsapp mr-1"></i> Confirmar</button>
                                <button onclick="openNextClientDetails()" class="bg-teal-700/50 text-white text-xs font-bold px-3 py-2 rounded-lg flex-1 hover:bg-teal-700 active:scale-95 transition">Ver Detalhes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mb-2"><i class="fa-solid fa-users"></i></div>
                        <div class="text-slate-400 text-[10px] font-bold uppercase">Total Pacientes</div>
                        <div class="text-2xl font-bold text-slate-800" id="dash-total-clients">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <div class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center mb-2"><i class="fa-solid fa-calendar-check"></i></div>
                        <div class="text-slate-400 text-[10px] font-bold uppercase">Sessões (Mês)</div>
                        <div class="text-2xl font-bold text-slate-800" id="dash-month-count">0</div>
                    </div>
                </div>
            </div>

            <div id="tab-calendar" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 flex justify-between items-center border-b border-slate-100">
                        <button onclick="changeAdminMonth(-1)" class="w-8 h-8 hover:bg-slate-50 rounded-full flex items-center justify-center text-slate-500"><i class="fa-solid fa-chevron-left"></i></button>
                        <h3 id="admin-calendar-month" class="font-bold text-slate-800 capitalize">Janeiro 2026</h3>
                        <button onclick="changeAdminMonth(1)" class="w-8 h-8 hover:bg-slate-50 rounded-full flex items-center justify-center text-slate-500"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-px bg-slate-100 border-b border-slate-100">
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">D</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">S</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">T</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">Q</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">Q</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">S</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">S</div>
                    </div>
                    <div id="admin-calendar-grid" class="grid grid-cols-7 gap-px bg-slate-100 p-px">
                        </div>
                </div>
                <div class="mt-4 flex justify-center gap-4 text-xs text-slate-500">
                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-teal-600"></span> Com Sessão</div>
                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300"></span> Vazio</div>
                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Cheio</div>
                </div>
            </div>

            <div id="tab-clients" class="tab-content hidden">
                <div class="relative mb-4">
                    <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                    <input type="text" id="client-search" onkeyup="renderClients()" placeholder="Buscar por nome..." class="w-full bg-white pl-10 pr-4 py-3 rounded-xl shadow-sm border-none focus:ring-2 focus:ring-teal-500 text-sm">
                </div>
                <div id="clients-list" class="space-y-3">
                    </div>
            </div>

            <div id="tab-financial" class="tab-content hidden">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center mb-6">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Estimativa Mensal</p>
                    <h2 class="text-4xl font-bold text-slate-800" id="fin-total">R$ 0,00</h2>
                    <p class="text-xs text-green-600 bg-green-50 inline-block px-3 py-1 rounded-full mt-3 font-medium">
                        <i class="fa-solid fa-arrow-trend-up mr-1"></i> Baseado em agendamentos
                    </p>
                </div>
                <h3 class="font-bold text-slate-700 text-sm mb-3">Histórico de Receita</h3>
                <div id="fin-history" class="space-y-3">
                    </div>
            </div>

            <div id="tab-settings" class="tab-content hidden">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-5">
                    <h3 class="font-bold text-slate-800 text-sm border-b border-slate-100 pb-2">Automação WhatsApp</h3>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Mensagem de Confirmação</label>
                        <textarea id="setting-msg-confirm" rows="3" class="input-field text-xs"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Link da Vídeo Chamada</label>
                        <input type="text" id="setting-video-link" placeholder="https://meet.google.com/..." class="input-field">
                    </div>

                    <button onclick="saveSettings()" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-teal-500/20 active:scale-95 transition">Salvar Configurações</button>
                </div>
                <div class="mt-6 text-center">
                    <button onclick="resetApp()" class="text-red-500 text-xs font-bold hover:underline">Resetar Dados do Aplicativo</button>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-booking" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-gray-900">Finalizar Agendamento</h3>
                <button onclick="closeModal('modal-booking')" class="w-8 h-8 bg-gray-100 rounded-full text-gray-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <form onsubmit="confirmBooking(event)" class="space-y-4">
                <input type="text" id="book-name" placeholder="Seu Nome Completo" required class="input-field">
                <input type="tel" id="book-phone" placeholder="Seu WhatsApp (11) 99999-9999" required class="input-field">
                <div class="bg-blue-50 p-3 rounded-xl flex gap-3">
                    <i class="fa-solid fa-circle-info text-blue-600 mt-0.5"></i>
                    <p class="text-xs text-blue-800">Ao confirmar, você receberá os detalhes da sessão via WhatsApp.</p>
                </div>
                <button type="submit" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl">Confirmar</button>
            </form>
        </div>
    </div>

    <div id="modal-day" class="modal-overlay hidden">
        <div class="modal-content h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 id="modal-day-title" class="font-bold text-xl text-slate-800">--</h3>
                    <p id="modal-day-date" class="text-xs text-slate-500">Gerenciar Dia</p>
                </div>
                <button onclick="closeModal('modal-day')" class="w-8 h-8 bg-slate-100 rounded-full text-slate-500"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="flex border-b border-slate-100 mb-4">
                <button onclick="switchDayTab('slots')" id="btn-tab-day-slots" class="flex-1 pb-2 text-sm font-bold text-teal-600 border-b-2 border-teal-600">Horários</button>
                <button onclick="switchDayTab('bookings')" id="btn-tab-day-bookings" class="flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent">Agendamentos</button>
            </div>

            <div id="day-content-slots" class="flex-1 overflow-y-auto">
                <div class="bg-slate-50 p-3 rounded-xl mb-4 border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Gerador em Massa</p>
                    <div class="flex gap-2">
                        <button onclick="bulkGenerate('morning')" class="flex-1 bg-white border border-slate-200 text-xs py-2 rounded-lg hover:border-teal-500 hover:text-teal-600 transition">Manhã (08-12)</button>
                        <button onclick="bulkGenerate('afternoon')" class="flex-1 bg-white border border-slate-200 text-xs py-2 rounded-lg hover:border-teal-500 hover:text-teal-600 transition">Tarde (13-18)</button>
                    </div>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <input type="time" id="new-slot-time" class="input-field py-2">
                    <button onclick="addSlot()" class="bg-teal-600 text-white px-4 rounded-xl shadow-lg shadow-teal-500/30"><i class="fa-solid fa-plus"></i></button>
                </div>

                <div id="admin-slots-list" class="grid grid-cols-4 gap-2">
                    </div>
            </div>

            <div id="day-content-bookings" class="hidden flex-1 overflow-y-auto space-y-3">
                </div>
        </div>
    </div>

    <div id="modal-notes" class="modal-overlay hidden">
        <div class="modal-content h-[70vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Prontuário Rápido</h3>
                <button onclick="closeModal('modal-notes')" class="w-8 h-8 bg-slate-100 rounded-full text-slate-500"><i class="fa-solid fa-times"></i></button>
            </div>
            <h4 id="notes-client-name" class="text-sm font-bold text-teal-600 mb-2">Cliente</h4>
            <textarea id="client-notes-area" class="flex-1 input-field mb-4 resize-none" placeholder="Escreva as anotações aqui..."></textarea>
            <button onclick="saveNotes()" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl">Salvar Anotação</button>
        </div>
    </div>
    <script>
        // --- ESTADO & DADOS ---
        const DB_PREFIX = 'psi_app_v1_';
        let state = {
            currentDate: new Date(),
            selectedDate: null, // YYYY-MM-DD
            adminDate: new Date(),
            selectedSlot: null,
            settings: JSON.parse(localStorage.getItem(DB_PREFIX + 'settings')) || {
                confirmMsg: "Olá, confirmo seu agendamento para o dia {data} às {hora}.",
                videoLink: ""
            }
        };

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            // Define data de hoje como padrão
            const todayISO = new Date().toISOString().split('T')[0];
            state.selectedDate = todayISO;
            
            // Renderizações Iniciais
            renderClientDates();
            renderClientSlots();
            
            // Carrega Configs
            document.getElementById('setting-msg-confirm').value = state.settings.confirmMsg;
            document.getElementById('setting-video-link').value = state.settings.videoLink;

            // Atualiza Dashboard Admin
            updateDashboard();
        }

        // --- SISTEMA DE DADOS (LOCALSTORAGE) ---
        const DataManager = {
            getSlots: () => JSON.parse(localStorage.getItem(DB_PREFIX + 'slots')) || {},
            saveSlots: (data) => localStorage.setItem(DB_PREFIX + 'slots', JSON.stringify(data)),
            
            getBookings: () => JSON.parse(localStorage.getItem(DB_PREFIX + 'bookings')) || [],
            saveBookings: (data) => localStorage.setItem(DB_PREFIX + 'bookings', JSON.stringify(data)),
            
            getNotes: () => JSON.parse(localStorage.getItem(DB_PREFIX + 'notes')) || {},
            saveNotes: (data) => localStorage.setItem(DB_PREFIX + 'notes', JSON.stringify(data)),
        };

        // --- NAVEGAÇÃO ---
        function navigateTo(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            window.scrollTo(0,0);
            
            if(viewId === 'view-admin') {
                renderAdminCalendar();
                updateDashboard();
            }
        }

        function switchTab(tabId) {
            // UI Abas
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[data-tab="${tabId}"]`).classList.add('active');
            
            // Conteúdo
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');

            if(tabId === 'dashboard') updateDashboard();
            if(tabId === 'calendar') renderAdminCalendar();
            if(tabId === 'clients') renderClients();
            if(tabId === 'financial') renderFinancial();
        }

        function checkAdmin() {
            const pass = prompt("Senha do Admin:");
            if(pass === "admin") { // Senha simples para demo
                navigateTo('view-admin');
            } else {
                alert("Senha incorreta");
            }
        }

        // --- LÓGICA DO CLIENTE ---
        function clientChangeDate(days) {
            const current = new Date(state.selectedDate + 'T00:00:00'); // Fix fuso horário básico
            current.setDate(current.getDate() + days);
            state.selectedDate = current.toISOString().split('T')[0];
            renderClientDates();
            renderClientSlots();
        }

        function setClientDate(dateIso) {
            state.selectedDate = dateIso;
            renderClientDates();
            renderClientSlots();
        }

        function renderClientDates() {
            const container = document.getElementById('client-date-scroll');
            const monthDisplay = document.getElementById('client-month-display');
            container.innerHTML = '';

            const baseDate = new Date(state.selectedDate + 'T00:00:00');
            monthDisplay.innerText = baseDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            // Gera 7 dias ao redor da data selecionada
            for (let i = -3; i <= 3; i++) {
                const d = new Date(baseDate);
                d.setDate(baseDate.getDate() + i);
                const iso = d.toISOString().split('T')[0];
                const dayNum = d.getDate();
                const weekDay = d.toLocaleDateString('pt-BR', { weekday: 'short' }).slice(0,3);
                
                // Checa disponibilidade visual
                const allSlots = DataManager.getSlots()[iso] || [];
                const bookings = DataManager.getBookings().filter(b => b.date === iso).map(b => b.time);
                const available = allSlots.filter(s => !bookings.includes(s)).length > 0;

                const btn = document.createElement('div');
                btn.className = `calendar-day flex-shrink-0 w-14 h-16 bg-white border border-gray-100 snap-center ${iso === state.selectedDate ? 'selected' : ''} ${available ? 'has-slots' : ''}`;
                btn.onclick = () => setClientDate(iso);
                btn.innerHTML = `
                    <span class="text-[10px] uppercase opacity-60">${weekDay}</span>
                    <span class="text-xl font-medium">${dayNum}</span>
                `;
                container.appendChild(btn);
            }
        }

        function renderClientSlots() {
            const grid = document.getElementById('client-slots-grid');
            const empty = document.getElementById('client-empty-state');
            const confirmBar = document.getElementById('client-confirm-bar');
            
            grid.innerHTML = '';
            state.selectedSlot = null;
            confirmBar.classList.remove('translate-y-0');
            confirmBar.classList.add('translate-y-full');

            const allSlots = DataManager.getSlots()[state.selectedDate] || [];
            // Filtra agendados
            const bookings = DataManager.getBookings().filter(b => b.date === state.selectedDate).map(b => b.time);
            
            // Ordena horários
            allSlots.sort();

            if(allSlots.length === 0 || allSlots.length === bookings.length) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            allSlots.forEach(time => {
                const isBooked = bookings.includes(time);
                const btn = document.createElement('button');
                btn.className = `time-slot p-3 rounded-xl font-medium text-sm text-center ${isBooked ? 'booked' : 'bg-white text-gray-700 hover:border-teal-500'}`;
                btn.innerText = time;
                
                if(!isBooked) {
                    btn.onclick = () => selectSlot(btn, time);
                }
                grid.appendChild(btn);
            });
        }

        function selectSlot(el, time) {
            document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected', 'bg-teal-600', 'text-white', 'border-teal-600'));
            el.classList.add('selected');
            
            state.selectedSlot = time;
            
            const dateFmt = new Date(state.selectedDate + 'T00:00:00').toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
            document.getElementById('client-selected-info').innerText = `${dateFmt} às ${time}`;
            
            document.getElementById('client-confirm-bar').classList.remove('translate-y-full');
            document.getElementById('client-confirm-bar').classList.add('translate-y-0');
        }

        function openBookingModal() {
            document.getElementById('modal-booking').classList.remove('hidden');
        }

        function confirmBooking(e) {
            e.preventDefault();
            const name = document.getElementById('book-name').value;
            const phone = document.getElementById('book-phone').value;

            if(!name || !phone) return alert('Preencha todos os dados');

            const bookings = DataManager.getBookings();
            const newBooking = {
                id: Date.now(),
                date: state.selectedDate,
                time: state.selectedSlot,
                clientName: name,
                clientPhone: phone,
                value: 150, // Valor fixo conforme HTML
                createdAt: new Date().toISOString()
            };

            bookings.push(newBooking);
            DataManager.saveBookings(bookings);

            // Geração de Link WhatsApp Automático
            const msg = state.settings.confirmMsg
                .replace('{data}', state.selectedDate.split('-').reverse().join('/'))
                .replace('{hora}', state.selectedSlot);
            
            const waLink = `https://wa.me/55${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`;
            
            closeModal('modal-booking');
            
            // Sucesso e Redirecionamento
            alert('Agendamento Confirmado! Você será redirecionado para o WhatsApp.');
            window.open(waLink, '_blank');
            
            // Reset UI
            renderClientSlots();
            renderClientDates(); // Atualiza indicadores
            navigateTo('view-profile');
        }


        // --- LÓGICA DO ADMIN ---

        // 1. Calendário Admin
        function changeAdminMonth(delta) {
            state.adminDate.setMonth(state.adminDate.getMonth() + delta);
            renderAdminCalendar();
        }

        function renderAdminCalendar() {
            const grid = document.getElementById('admin-calendar-grid');
            const title = document.getElementById('admin-calendar-month');
            grid.innerHTML = '';

            const year = state.adminDate.getFullYear();
            const month = state.adminDate.getMonth();
            
            title.innerText = state.adminDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Padding dias vazios
            for(let i=0; i<firstDay; i++) {
                grid.innerHTML += `<div class="bg-slate-50 h-24"></div>`;
            }

            const slotsMap = DataManager.getSlots();
            const bookings = DataManager.getBookings();

            for(let d=1; d<=daysInMonth; d++) {
                const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                const slots = slotsMap[iso] || [];
                const dayBookings = bookings.filter(b => b.date === iso);
                
                // Lógica de Cores/Status
                let statusClass = '';
                if(slots.length === 0) statusClass = 'text-slate-400'; // Vazio
                else if(dayBookings.length >= slots.length) statusClass = 'text-red-500 font-bold bg-red-50'; // Cheio
                else if(dayBookings.length > 0) statusClass = 'text-teal-600 font-bold bg-teal-50'; // Parcial
                else statusClass = 'text-slate-700 bg-white'; // Livre

                // Dots
                let dots = '';
                if(dayBookings.length > 0) dots = `<span class="w-1.5 h-1.5 bg-teal-500 rounded-full mx-auto mt-1 block"></span>`;

                const dayEl = document.createElement('div');
                dayEl.className = `h-24 border border-slate-50 p-1 cursor-pointer hover:bg-slate-100 transition relative flex flex-col items-center justify-center ${statusClass}`;
                dayEl.onclick = () => openDayModal(iso);
                dayEl.innerHTML = `
                    <span class="text-sm">${d}</span>
                    ${dots}
                    <span class="text-[9px] mt-1 opacity-70">${slots.length > 0 ? `${dayBookings.length}/${slots.length}` : ''}</span>
                `;
                grid.appendChild(dayEl);
            }
        }

        // 2. Modal do Dia (Gestão)
        let currentModalDate = null;
        
        function openDayModal(iso) {
            currentModalDate = iso;
            const d = new Date(iso + 'T00:00:00');
            document.getElementById('modal-day-title').innerText = d.getDate();
            document.getElementById('modal-day-date').innerText = d.toLocaleDateString('pt-BR', {weekday: 'long', month:'long'});
            
            document.getElementById('modal-day').classList.remove('hidden');
            
            // Default tab
            switchDayTab('slots');
            renderAdminDaySlots();
            renderAdminDayBookings();
        }

        function switchDayTab(tab) {
            if(tab === 'slots') {
                document.getElementById('day-content-slots').classList.remove('hidden');
                document.getElementById('day-content-bookings').classList.add('hidden');
                document.getElementById('btn-tab-day-slots').className = "flex-1 pb-2 text-sm font-bold text-teal-600 border-b-2 border-teal-600";
                document.getElementById('btn-tab-day-bookings').className = "flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent";
            } else {
                document.getElementById('day-content-slots').classList.add('hidden');
                document.getElementById('day-content-bookings').classList.remove('hidden');
                document.getElementById('btn-tab-day-slots').className = "flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent";
                document.getElementById('btn-tab-day-bookings').className = "flex-1 pb-2 text-sm font-bold text-teal-600 border-b-2 border-teal-600";
            }
        }

        // 3. Gestão de Slots
        function addSlot() {
            const time = document.getElementById('new-slot-time').value;
            if(!time) return;

            const slotsMap = DataManager.getSlots();
            if(!slotsMap[currentModalDate]) slotsMap[currentModalDate] = [];
            
            if(!slotsMap[currentModalDate].includes(time)) {
                slotsMap[currentModalDate].push(time);
                slotsMap[currentModalDate].sort();
                DataManager.saveSlots(slotsMap);
                renderAdminDaySlots();
                renderAdminCalendar(); // Atualiza contador na view mensal
            }
        }

        function removeSlot(time) {
            const slotsMap = DataManager.getSlots();
            const bookings = DataManager.getBookings().filter(b => b.date === currentModalDate && b.time === time);
            
            if(bookings.length > 0) {
                alert("Não é possível remover um horário que já possui agendamento. Cancele o agendamento primeiro.");
                return;
            }

            slotsMap[currentModalDate] = slotsMap[currentModalDate].filter(t => t !== time);
            DataManager.saveSlots(slotsMap);
            renderAdminDaySlots();
            renderAdminCalendar();
        }

        function bulkGenerate(period) {
            if(!confirm("Isso adicionará vários horários. Confirmar?")) return;
            
            const slotsMap = DataManager.getSlots();
            if(!slotsMap[currentModalDate]) slotsMap[currentModalDate] = [];

            let start, end;
            if(period === 'morning') { start = 8; end = 12; }
            if(period === 'afternoon') { start = 13; end = 18; }

            for(let h = start; h <= end; h++) {
                const timeStr = `${String(h).padStart(2,'0')}:00`;
                if(!slotsMap[currentModalDate].includes(timeStr)) {
                    slotsMap[currentModalDate].push(timeStr);
                }
            }
            slotsMap[currentModalDate].sort();
            DataManager.saveSlots(slotsMap);
            renderAdminDaySlots();
            renderAdminCalendar();
        }

        function renderAdminDaySlots() {
            const list = document.getElementById('admin-slots-list');
            list.innerHTML = '';
            
            const slotsMap = DataManager.getSlots();
            const daySlots = slotsMap[currentModalDate] || [];
            const bookings = DataManager.getBookings().filter(b => b.date === currentModalDate).map(b => b.time);

            daySlots.forEach(time => {
                const isBooked = bookings.includes(time);
                const el = document.createElement('div');
                el.className = `flex items-center justify-between p-2 rounded-lg text-xs font-bold border ${isBooked ? 'bg-teal-50 border-teal-200 text-teal-700' : 'bg-white border-slate-200 text-slate-600'}`;
                el.innerHTML = `
                    <span>${time}</span>
                    ${!isBooked ? `<button onclick="removeSlot('${time}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>` : '<i class="fa-solid fa-check text-teal-500"></i>'}
                `;
                list.appendChild(el);
            });
        }

        // 4. Gestão de Agendamentos (Dentro do dia)
        function renderAdminDayBookings() {
            const container = document.getElementById('day-content-bookings');
            container.innerHTML = '';

            const bookings = DataManager.getBookings()
                .filter(b => b.date === currentModalDate)
                .sort((a,b) => a.time.localeCompare(b.time));

            if(bookings.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 text-sm py-4">Nenhum agendamento para este dia.</p>';
                return;
            }

            bookings.forEach(booking => {
                const card = document.createElement('div');
                card.className = "bg-white p-3 rounded-xl border border-slate-100 shadow-sm relative";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="bg-teal-100 text-teal-700 text-[10px] font-bold px-2 py-0.5 rounded">${booking.time}</span>
                            <h4 class="font-bold text-slate-800 text-sm mt-1">${booking.clientName}</h4>
                        </div>
                        <button onclick="deleteBooking(${booking.id})" class="text-red-400 hover:text-red-600 text-xs"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="flex gap-2">
                        <a href="https://wa.me/55${booking.clientPhone.replace(/\D/g,'')}" target="_blank" class="flex-1 bg-green-50 text-green-600 text-center py-1.5 rounded-lg text-xs font-bold"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
                        <button onclick="openNotesModal('${booking.clientPhone}', '${booking.clientName}')" class="flex-1 bg-slate-100 text-slate-600 py-1.5 rounded-lg text-xs font-bold">Prontuário</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function deleteBooking(id) {
            if(!confirm('Tem certeza que deseja cancelar este agendamento?')) return;
            
            let bookings = DataManager.getBookings().filter(b => b.id !== id);
            DataManager.saveBookings(bookings);
            
            renderAdminDayBookings();
            renderAdminDaySlots(); // Atualiza status visual dos slots
            renderAdminCalendar(); // Atualiza dots
            updateDashboard(); // Atualiza stats
        }

        // 5. Dashboard
        function updateDashboard() {
            const bookings = DataManager.getBookings();
            const now = new Date();
            const currentMonthISO = now.toISOString().slice(0,7); // YYYY-MM

            // Filtra próximo atendimento (Data >= Hoje e Hora > Agora se for hoje)
            const upcoming = bookings.filter(b => {
                const bDate = new Date(b.date + 'T' + b.time + ':00');
                return bDate >= now;
            }).sort((a,b) => {
                const dateA = new Date(a.date + 'T' + a.time);
                const dateB = new Date(b.date + 'T' + b.time);
                return dateA - dateB;
            });

            // Update UI Próximo
            if(upcoming.length > 0) {
                const next = upcoming[0];
                const isToday = next.date === now.toISOString().split('T')[0];
                
                document.getElementById('dash-next-badge').innerText = isToday ? 'HOJE' : next.date.split('-').reverse().join('/');
                document.getElementById('dash-next-time').innerText = next.time;
                document.getElementById('dash-next-client').innerText = next.clientName;
                
                // Salva ID para ações rápidas
                document.getElementById('dash-next-content').dataset.nextPhone = next.clientPhone;
                document.getElementById('dash-next-content').dataset.nextName = next.clientName;
            } else {
                document.getElementById('dash-next-time').innerText = "--:--";
                document.getElementById('dash-next-client').innerText = "Sem próximos agendamentos";
            }

            // Stats
            const uniqueClients = [...new Set(bookings.map(b => b.clientPhone))].length;
            const monthSessions = bookings.filter(b => b.date.startsWith(currentMonthISO)).length;

            document.getElementById('dash-total-clients').innerText = uniqueClients;
            document.getElementById('dash-month-count').innerText = monthSessions;
        }

        // Ações Rápidas Dashboard
        function sendQuickMsg() {
            const el = document.getElementById('dash-next-content');
            const phone = el.dataset.nextPhone;
            if(phone) {
                window.open(`https://wa.me/55${phone.replace(/\D/g,'')}`, '_blank');
            }
        }
        function openNextClientDetails() {
            const el = document.getElementById('dash-next-content');
            const phone = el.dataset.nextPhone;
            const name = el.dataset.nextName;
            if(phone) openNotesModal(phone, name);
        }

        // 6. Clientes e Prontuários
        let currentNoteClient = null; // Chave é o telefone

        function renderClients() {
            const search = document.getElementById('client-search').value.toLowerCase();
            const list = document.getElementById('clients-list');
            list.innerHTML = '';

            const bookings = DataManager.getBookings();
            // Agrupar por telefone (ID único neste sistema simples)
            const clientsMap = {};
            bookings.forEach(b => {
                if(!clientsMap[b.clientPhone]) {
                    clientsMap[b.clientPhone] = { name: b.clientName, phone: b.clientPhone, lastDate: b.date };
                } else {
                    // Atualiza última data se for mais recente
                    if(b.date > clientsMap[b.clientPhone].lastDate) clientsMap[b.clientPhone].lastDate = b.date;
                }
            });

            const clients = Object.values(clientsMap).filter(c => c.name.toLowerCase().includes(search));

            clients.forEach(c => {
                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center";
                el.innerHTML = `
                    <div>
                        <h4 class="font-bold text-slate-800">${c.name}</h4>
                        <p class="text-xs text-slate-500">Última sessão: ${c.lastDate.split('-').reverse().join('/')}</p>
                    </div>
                    <button onclick="openNotesModal('${c.phone}', '${c.name}')" class="w-8 h-8 bg-teal-50 text-teal-600 rounded-lg flex items-center justify-center hover:bg-teal-100">
                        <i class="fa-solid fa-file-medical"></i>
                    </button>
                `;
                list.appendChild(el);
            });
        }

        function openNotesModal(phone, name) {
            currentNoteClient = phone;
            document.getElementById('modal-notes').classList.remove('hidden');
            document.getElementById('notes-client-name').innerText = name;
            
            const notes = DataManager.getNotes();
            document.getElementById('client-notes-area').value = notes[phone] || '';
        }

        function saveNotes() {
            const text = document.getElementById('client-notes-area').value;
            const notes = DataManager.getNotes();
            notes[currentNoteClient] = text;
            DataManager.saveNotes(notes);
            
            closeModal('modal-notes');
            // Toast simulado
            const btn = document.querySelector('#modal-notes button');
            const originalText = btn.innerText;
            btn.innerText = "Salvo!";
            setTimeout(() => btn.innerText = originalText, 1000);
        }

        // 7. Financeiro
        function renderFinancial() {
            const history = document.getElementById('fin-history');
            const totalEl = document.getElementById('fin-total');
            history.innerHTML = '';

            const bookings = DataManager.getBookings();
            
            // Agrupar por Mês
            const monthsMap = {};
            bookings.forEach(b => {
                const key = b.date.slice(0,7); // YYYY-MM
                if(!monthsMap[key]) monthsMap[key] = 0;
                monthsMap[key] += (b.value || 150);
            });

            // Total estimado do mês ATUAL
            const currentMonth = new Date().toISOString().slice(0,7);
            const total = monthsMap[currentMonth] || 0;
            totalEl.innerText = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            // Histórico
            Object.keys(monthsMap).sort().reverse().forEach(key => {
                const [y, m] = key.split('-');
                const dateObj = new Date(parseInt(y), parseInt(m)-1);
                const monthName = dateObj.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                const row = document.createElement('div');
                row.className = "flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100";
                row.innerHTML = `
                    <span class="text-sm text-slate-600 capitalize font-medium">${monthName}</span>
                    <span class="text-sm font-bold text-slate-800">${monthsMap[key].toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                `;
                history.appendChild(row);
            });
        }

        // 8. Configurações
        function saveSettings() {
            state.settings.confirmMsg = document.getElementById('setting-msg-confirm').value;
            state.settings.videoLink = document.getElementById('setting-video-link').value;
            
            localStorage.setItem(DB_PREFIX + 'settings', JSON.stringify(state.settings));
            alert('Configurações salvas com sucesso!');
        }

        function resetApp() {
            if(confirm("ATENÇÃO: Isso apagará TODOS os dados (agendamentos, clientes, anotações). Deseja continuar?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // Helpers UI
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // Fechar modal ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if(e.target === overlay) overlay.classList.add('hidden');
            });
        });

    </script>
</body>
</html>
