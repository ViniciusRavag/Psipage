<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Psi. Vinicius Ravagnani</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Animações e Transições */
        .view-section {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            min-height: 100vh;
        }
        
        .view-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            z-index: 50;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        .modal-overlay.hidden {
            display: none;
        }
        
        #modal-bulk-generate {
  z-index: 60; /* Um valor maior que o z-index padrão dos outros modais (50) */
}
        
        .modal-content {
            background: white;
            width: 100%;
            max-width: 450px;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
        }
        
        @media(min-width: 640px) {
            .modal-overlay {
                align-items: center;
            }
            
            .modal-content {
                border-radius: 20px;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            
            to {
                transform: translateY(0);
            }
        }
        
        /* Estilos Específicos */
        .time-slot {
            transition: all 0.2s;
            border: 1px solid #E5E7EB;
        }
        
        .time-slot.selected {
            background-color: #22c55e;
            color: white;
            border-color: #22c55e;
            box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3);
        }
        
        .time-slot.booked {
            background-color: #F3F4F6;
            color: #9CA3AF;
            text-decoration: line-through;
            pointer-events: none;
            border-color: transparent;
        }
        
        .nav-tab {
            white-space: nowrap;
            padding: 12px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748B;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .nav-tab.active {
            color: #0D9488;
            border-bottom-color: #0D9488;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 0.9rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            width: 14%;
        }
        
        .calendar-day:hover {
            background-color: #F1F5F9;
        }
        
        .calendar-day.has-slots {
            font-weight: 700;
            color: #0F172A;
        }
        
        .calendar-day.has-slots::after {
            content: '';
            width: 4px;
            height: 4px;
            background: #22c55e;
            border-radius: 50%;
            position: absolute;
            bottom: 6px;
        }
        
        .calendar-day.full {
            color: #EF4444;
        }
        
        .calendar-day.selected {
            background-color: #0D9488;
            color: white;
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
        }
        
        .calendar-day.selected::after {
            background: white;
        }
        
        .input-field {
            width: 100%;
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            padding: 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            border-color: #0D9488;
            background: white;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1);
        }
        
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 40;
            transition: transform 0.2s;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        /* Loader styles */
        .loader {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0D9488;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            
            100% {
                transform: rotate(360deg);
            }
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #0D9488;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.error {
            background: #ef4444;
        }
        
        .admin-panel {
            background-color: #f8fafc;
            height: 100vh;
            overflow-y: auto;
        }
        
        .dashboard-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .stats-number {
            font-size: 2.5rem;
            line-height: 1;
            font-weight: 800;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.6;
        }
        
        .empty-state p {
            font-size: 1.1rem;
            margin-top: 8px;
        }
        
        .month-view {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .booking-card {
            transition: all 0.2s;
            border-left: 3px solid #0D9488;
        }
        
        .booking-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .nav-pills .nav-link.active {
            background-color: #0D9488;
            color: white;
        }
        
        .nav-pills .nav-link {
            color: #4b5563;
        }
    </style>
</head>
<body class="text-gray-800 antialiased pb-safe">
    <!-- Toast Notification -->
    <div id="toast-notification" class="toast">Mensagem de sucesso</div>

    <!-- View: Profile (Client View) -->
    <div id="settings-container" style="display: none;"></div>
    <div id="view-profile" class="view-section active max-w-md mx-auto bg-white min-h-screen shadow-2xl relative z-10 pb-20">
        <div class="h-32 relative"> <!-- Removido overflow-hidden -->
  <!-- Imagem de fundo -->
  <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://framerusercontent.com/images/q8eeJ7hPEZipYL1UGvk7tw6xVyY.png')"></div>
  
  <!-- Overlay escuro para melhor legibilidade do texto -->
  <div class="absolute inset-0 bg-black/30"></div>
  
  <!-- Botão de administrador -->
  <button onclick="checkAdmin()" class="absolute top-4 right-4 text-white/70 hover:text-white p-2 z-10">
    <i class="fa-solid fa-lock"></i>
  </button>
  
  <!-- Correção: foto de perfil mais à esquerda -->
  <div class="absolute left-4 -bottom-16 z-10"> <!-- Apenas left-4, sem transform -->
    <div class="w-32 h-32 rounded-full border-4 border-white shadow-lg bg-white overflow-hidden">
      <img src="https://framerusercontent.com/images/AywivnTTPbGpswKf6h17Q7KBIw.jpeg" alt="Vinicius" class="w-full h-full object-cover">
    </div>
  </div>
</div>
<div class="px-6 mt-16 relative">
            <div class="mt-4 flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Vinicius Ravagnani</h1>
                    <p class="text-sm text-amber-800 font-medium">Psicólogo Clínico &bull; CRP 06/12345</p>
                </div>
                <div class="text-right bg-green-50 px-3 py-1 rounded-lg">
                    <p class="text-lg font-bold text-green-700">R$ 90</p>
                    <p class="text-[10px] text-green-700 font-bold uppercase">Sessão 50min</p>
                </div>
            </div>
            <div class="mt-6 space-y-6">
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Especialidades</h3>
                    <div class="flex flex-wrap gap-2">
                        <span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">Terapia Cognitivo-Comportamental</span>
                        <span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">Ansiedade</span>
                        <span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">Autoconhecimento</span>
                    </div>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Sobre</h3>
                    <p class="text-sm text-gray-600 leading-relaxed">
                        Olá! Sou o Vinicius. Meu objetivo é oferecer um espaço seguro e acolhedor para que você possa explorar seus sentimentos e desenvolver ferramentas para lidar com os desafios da vida.
                    </p>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Formação</h3>
                    <p class="text-sm text-gray-600">
                        <span class="font-medium">Graduação:</span> Psicologia pela Universidade de Franca (UNIFRAN)<br>
                        <span class="font-medium">Especialização:</span> Terapia Cognitivo-Comportamental pelo Instituto Beck
                    </p>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Atendimento</h3>
                    <p class="text-sm text-gray-600">
                        <i class="fa-solid fa-calendar-days text-blue-500 mr-2"></i>Segunda a Sexta-feira<br>
                        <i class="fa-solid fa-clock text-blue-500 mr-2"></i>08:30 às 18:00<br>
                        <i class="fa-solid fa-house text-blue-500 mr-2"></i>Atendimento Online
                    </p>
                </div>
            </div>
            <div class="mt-8 pt-6 border-t border-gray-100">
                <h3 class="text-sm font-bold text-gray-700 mb-3">Depoimentos</h3>
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <div class="flex items-center mb-2">
                            <div class="w-8 h-8 rounded-full bg-yellow-400 flex items-center justify-center mr-2">
                                <span class="text-xs font-bold text-white">A</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">Ana S.</p>
                                <div class="flex text-yellow-400">
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star"></i>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 italic">"O acompanhamento com o Vinicius tem sido transformador na minha vida. Recomendo muito!"</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <div class="flex items-center mb-2">
                            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center mr-2">
                                <span class="text-xs font-bold text-white">M</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">Marcos R.</p>
                                <div class="flex text-yellow-400">
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star"></i>
                                    <i class="fa-solid fa-star-half-stroke"></i>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 italic">"Profissional extremamente qualificado e atencioso. Me ajudou a superar minha ansiedade."</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="sticky bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-md border-t border-gray-100 z-20">
  <button onclick="navigateTo('view-client-calendar')" class="w-full bg-amber-700 hover:bg-amber-800 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-[0.98] flex justify-center items-center gap-2">
    <i class="fa-regular fa-calendar"></i> Agendar Sessão
  </button>
</div>
    </div>

    <!-- View: Client Calendar -->
    <div id="view-client-calendar" class="view-section max-w-md mx-auto bg-gray-50 min-h-screen relative">
        <div class="bg-white px-4 py-4 shadow-sm sticky top-0 z-20 flex items-center gap-4">
            <button onclick="navigateTo('view-profile')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h2 class="font-bold text-gray-800 text-lg">Escolha um horário</h2>
        </div>
        <div class="p-4">
            <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-700" id="client-month-display">Janeiro</h3>
                    <div class="flex gap-2">
                        <button onclick="clientChangeDate(-1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fa-solid fa-chevron-left text-xs"></i>
                        </button>
                        <button onclick="clientChangeDate(1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fa-solid fa-chevron-right text-xs"></i>
                        </button>
                    </div>
                </div>
                <div id="client-date-scroll" class="flex overflow-x-auto gap-3 pb-2 no-scrollbar snap-x">
                    <!-- Dates will be populated here by JS -->
                </div>
            </div>
            <div id="client-slots-container">
                <div id="client-slots-grid" class="grid grid-cols-3 gap-3">
                    <!-- Time slots will be populated here by JS -->
                </div>
                <div id="client-empty-state" class="hidden text-center py-10">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400">
                        <i class="fa-regular fa-calendar-xmark text-2xl"></i>
                    </div>
                    <p class="text-gray-500 text-sm">Nenhum horário disponível nesta data. Por favor, selecione outra data.</p>
                </div>
            </div>
        </div>
        <div id="client-confirm-bar" class="fixed bottom-0 left-0 right-0 bg-white p-4 border-t border-gray-100 max-w-md mx-auto transform translate-y-full transition-transform duration-300 shadow-[0_-4px_20px_rgba(0,0,0,0.1)]">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <p class="text-xs text-gray-500 font-medium uppercase">Horário Selecionado</p>
                    <p id="client-selected-info" class="text-sm font-bold text-gray-900">--/-- às --:--</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500 font-medium uppercase">Valor</p>
                    <p class="text-sm font-bold text-blue-600">R$ 150,00</p>
                </div>
            </div>
            <button onclick="openBookingModal()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-600/20 flex items-center justify-center gap-2">
                <i class="fa-solid fa-check"></i> Solicitar Agendamento
            </button>
        </div>
    </div>

    <!-- View: Admin (separated route) -->
    <div id="settings-container" style="display: none;"></div>
    <div id="view-admin" class="view-section admin-panel">
        <div class="bg-white px-5 py-4 shadow-sm sticky top-0 z-30 flex justify-between items-center">
            <div>
                <h2 class="font-bold text-lg text-slate-800">Painel<span class="text-teal-600">Psi</span> <span class="text-xs bg-teal-100 text-teal-800 px-2 py-0.5 rounded-full">Admin</span></h2>
            </div>
            <button onclick="logoutAdmin()" class="text-xs font-semibold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full hover:bg-slate-200">
                <i class="fa-solid fa-arrow-right-from-bracket mr-1"></i> Sair
            </button>
        </div>
        <div class="bg-white border-b border-slate-100 flex overflow-x-auto sticky top-[60px] z-20 hide-scrollbar px-2">
            <button onclick="switchTab('dashboard')" class="nav-tab active" data-tab="dashboard">
                <i class="fa-solid fa-gauge mr-1"></i> Visão Geral
            </button>
            <button onclick="switchTab('calendar')" class="nav-tab" data-tab="calendar">
                <i class="fa-regular fa-calendar-days mr-1"></i> Agenda
            </button>
            <button onclick="switchTab('clients')" class="nav-tab" data-tab="clients">
                <i class="fa-solid fa-users mr-1"></i> Pacientes
            </button>
            <button onclick="switchTab('financial')" class="nav-tab" data-tab="financial">
                <i class="fa-solid fa-chart-line mr-1"></i> Financeiro
            </button>
            <button onclick="switchTab('reports')" class="nav-tab" data-tab="reports">
                <i class="fa-solid fa-file-lines mr-1"></i> Relatórios
            </button>
            <button onclick="switchTab('settings')" class="nav-tab" data-tab="settings">
                <i class="fa-solid fa-gear mr-1"></i> Config
            </button>
        </div>
        <div class="p-4">
            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content block">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-teal-600 to-teal-500 text-white rounded-2xl p-6 shadow-lg shadow-teal-500/20 relative overflow-hidden dashboard-card">
                        <div class="absolute -right-6 -top-6 bg-white/20 w-32 h-32 rounded-full blur-2xl"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-teal-50 font-medium text-xs uppercase tracking-wider">Próxima Sessão</h3>
                                <span id="dash-next-badge" class="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold">HOJE</span>
                            </div>
                            <div id="dash-next-content">
                                <p id="dash-next-time" class="text-4xl font-bold mb-1">--:--</p>
                                <p id="dash-next-client" class="text-teal-50 font-medium text-lg truncate">Nenhum agendamento</p>
                                <div class="mt-5 grid grid-cols-2 gap-3">
                                    <button onclick="sendQuickMsg()" class="bg-white/90 text-teal-700 font-bold px-4 py-3 rounded-xl flex flex-col items-center justify-center hover:bg-white transition active:scale-95">
                                        <i class="fa-brands fa-whatsapp text-2xl mb-1"></i>
                                        <span class="text-xs font-medium">Mensagem</span>
                                    </button>
                                    <button onclick="openNextClientDetails()" class="bg-teal-700/50 text-white font-bold px-4 py-3 rounded-xl flex flex-col items-center justify-center hover:bg-teal-700 transition active:scale-95">
                                        <i class="fa-solid fa-user-injured text-2xl mb-1"></i>
                                        <span class="text-xs font-medium">Prontuário</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 dashboard-card">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-3">
                                <i class="fa-solid fa-users text-xl"></i>
                            </div>
                            <div class="text-slate-400 text-[10px] font-bold uppercase">Total Pacientes</div>
                            <div class="stats-number text-slate-800" id="dash-total-clients">0</div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 dashboard-card">
                            <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-3">
                                <i class="fa-solid fa-calendar-check text-xl"></i>
                            </div>
                            <div class="text-slate-400 text-[10px] font-bold uppercase">Sessões (Mês)</div>
                            <div class="stats-number text-slate-800" id="dash-month-count">0</div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 dashboard-card">
                            <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mb-3">
                                <i class="fa-solid fa-money-bill-wave text-xl"></i>
                            </div>
                            <div class="text-slate-400 text-[10px] font-bold uppercase">Faturamento</div>
                            <div class="text-lg font-bold text-slate-800" id="dash-month-revenue">R$ 0,00</div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 dashboard-card">
                            <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center mb-3">
                                <i class="fa-solid fa-clock text-xl"></i>
                            </div>
                            <div class="text-slate-400 text-[10px] font-bold uppercase">Disponibilidade</div>
                            <div class="text-lg font-bold text-slate-800" id="dash-availability">0%</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-6">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">Agendamentos dos Próximos 7 Dias</h3>
                        <button onclick="navigateToTab('calendar')" class="text-teal-600 text-sm font-medium hover:text-teal-700 flex items-center">
                            Ver agenda completa <i class="fa-solid fa-arrow-right ml-1 text-xs"></i>
                        </button>
                    </div>
                    <div id="upcoming-appointments" class="p-4">
                        <div class="flex justify-center items-center py-6">
                            <div class="text-center">
                                <div class="loader mx-auto mb-3"></div>
                                <p class="text-slate-500">Carregando agendamentos...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-5 border-b border-slate-100">
                            <h3 class="font-bold text-slate-800">Últimos Pacientes</h3>
                        </div>
                        <div id="recent-clients" class="p-4 max-h-80 overflow-y-auto">
                            <div class="flex justify-center items-center py-6">
                                <div class="text-center">
                                    <div class="loader mx-auto mb-3"></div>
                                    <p class="text-slate-500">Carregando pacientes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-5 border-b border-slate-100">
                            <h3 class="font-bold text-slate-800">Sessões por Dia da Semana</h3>
                        </div>
                        <div class="p-6">
                            <div id="chart-weekday" class="h-60 flex items-end justify-around">
                                <div class="text-center">
                                    <div class="bg-gray-200 w-6 rounded-t-lg mx-auto" style="height: 30px;"></div>
                                    <span class="text-xs mt-1 block text-gray-500">Dom</span>
                                </div>
                                <div class="text-center">
                                    <div class="bg-blue-400 w-6 rounded-t-lg mx-auto" style="height: 80px;"></div>
                                    <span class="text-xs mt-1 block text-gray-500">Seg</span>
                                </div>
                                <div class="text-center">
                                    <div class="bg-blue-400 w-6 rounded-t-lg mx-auto" style="height: 120px;"></div>
                                    <span class="text-xs mt-1 block text-gray-500">Ter</span>
                                </div>
                                <div class="text-center">
                                    <div class="bg-blue-400 w-6 rounded-t-lg mx-auto" style="height: 150px;"></div>
                                    <span class="text-xs mt-1 block text-gray-500">Qua</span>
                                </div>
                                <div class="text-center">
                                    <div class="bg-blue-400 w-6 rounded-t-lg mx-auto" style="height: 100px;"></div>
                                    <span class="text-xs mt-1 block text-gray-500">Qui</span>
                                </div>
                                <div class="text-center">
                                    <div class="bg-blue-400 w-6 rounded-t-lg mx-auto" style="height: 90px;"></div>
                                    <span class="text-xs mt-1 block text-gray-500">Sex</span>
                                </div>
                                <div class="text-center">
                                    <div class="bg-gray-200 w-6 rounded-t-lg mx-auto" style="height: 20px;"></div>
                                    <span class="text-xs mt-1 block text-gray-500">Sáb</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Tab -->
            <div id="tab-calendar" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden month-view">
                    <div class="p-4 flex justify-between items-center border-b border-slate-100">
                        <button onclick="changeAdminMonth(-1)" class="w-10 h-10 hover:bg-slate-50 rounded-full flex items-center justify-center text-slate-500">
                            <i class="fa-solid fa-chevron-left text-xl"></i>
                        </button>
                        <h3 id="admin-calendar-month" class="font-bold text-slate-800 text-lg capitalize">Janeiro 2026</h3>
                        <button onclick="changeAdminMonth(1)" class="w-10 h-10 hover:bg-slate-50 rounded-full flex items-center justify-center text-slate-500">
                            <i class="fa-solid fa-chevron-right text-xl"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 gap-px bg-slate-100">
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">D</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">S</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">T</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">Q</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">Q</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">S</div>
                        <div class="bg-slate-50 py-2 text-center text-[10px] font-bold text-slate-400 uppercase">S</div>
                    </div>
                    <div id="admin-calendar-grid" class="grid grid-cols-7 gap-px bg-slate-100 p-px min-h-[500px]">
                        <!-- Calendar days will be populated here -->
                    </div>
                </div>
                <div class="mt-4 flex justify-center gap-4 text-xs text-slate-500">
                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-teal-600"></span> Com Sessão</div>
                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300"></span> Vazio</div>
                    <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Cheio</div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 mt-6 p-5">
<div class="flex items-start">
<div class="bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center mr-3 mt-1 flex-shrink-0">
<i class="fa-solid fa-calendar-plus"></i>
</div>
<div class="flex-1">
<h4 class="font-bold text-slate-800">Exportar para Google Agenda</h4>
<p class="text-sm text-slate-600 mb-3">Clique para exportar os agendamentos direto no seu Google Agenda e receber os lembretes no seu celular</p>
<button onclick="generateICSFile()" class="text-sm bg-green-600 text-white px-4 py-2.5 rounded-lg hover:bg-green-700 transition flex items-center shadow-md">
<i class="fa-solid fa-download mr-2"></i> Exportar Agendamentos
</button>
<p class="text-xs text-slate-500 mt-3 bg-green-50 p-3 rounded-lg">
<i class="fa-solid fa-circle-info text-green-600 mr-1"></i>
Se estiver acessando pelo computador, após baixar o arquivo .ics, abra o Google Agenda, clique em "Importar" nas configurações e selecione o arquivo para adicionar todos os seus agendamentos.
</p>
</div>
</div>
</div>
            </div>

            <!-- Clients Tab -->
            <div id="tab-clients" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-6">
                    <div class="p-4">
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                            <input type="text" id="client-search" onkeyup="renderClients()" placeholder="Buscar por nome, telefone ou e-mail..." class="w-full bg-slate-50 pl-10 pr-4 py-3 rounded-xl shadow-sm border border-slate-200 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 text-sm transition">
                        </div>
                    </div>
                    <div class="border-t border-slate-100 p-3 bg-slate-50 flex justify-between items-center">
                        <div class="text-xs text-slate-500">
                            <span id="clients-count">0</span> pacientes encontrados
                        </div>
                        <div class="flex gap-2">
                            <button onclick="exportClientsToCSV()" class="text-xs bg-white px-3 py-1.5 rounded-lg border border-slate-300 hover:bg-slate-50 flex items-center">
                                <i class="fa-solid fa-file-csv mr-1"></i> Exportar CSV
                            </button>
                            <button onclick="openNewClientModal()" class="text-xs bg-teal-600 text-white px-3 py-1.5 rounded-lg hover:bg-teal-700 flex items-center">
                                <i class="fa-solid fa-plus mr-1"></i> Novo Paciente
                            </button>
                        </div>
                    </div>
                </div>

                <div id="clients-list" class="space-y-3">
                    <!-- Client cards will be populated here -->
                    <div class="flex justify-center items-center py-10">
                        <div class="text-center">
                            <div class="loader mx-auto mb-3"></div>
                            <p class="text-slate-500">Carregando pacientes...</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-center">
                    <button id="load-more-clients" class="px-4 py-2 text-teal-600 font-medium rounded-lg border border-teal-200 bg-teal-50 hover:bg-teal-100 hidden">
                        Carregar mais pacientes
                    </button>
                </div>
            </div>

            <!-- Financial Tab -->
            <div id="tab-financial" class="tab-content hidden">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 text-center mb-6">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Estimativa Mensal</p>
                    <h2 class="text-4xl font-bold text-slate-800" id="fin-total">R$ 0,00</h2>
                    <p class="text-xs text-green-600 bg-green-50 inline-block px-3 py-1 rounded-full mt-3 font-medium">
                        <i class="fa-solid fa-arrow-trend-up mr-1"></i> Baseado em agendamentos confirmados
                    </p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-xs text-slate-400 font-bold uppercase mb-1">Sessões Realizadas</p>
                        <p class="text-2xl font-bold text-slate-800" id="fin-sessions-done">0</p>
                        <p class="text-xs text-slate-500 mt-1">Este mês</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-xs text-slate-400 font-bold uppercase mb-1">Taxa de Cancelamento</p>
                        <p class="text-2xl font-bold text-slate-800" id="fin-cancellation-rate">0%</p>
                        <p class="text-xs text-slate-500 mt-1">Últimos 30 dias</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-xs text-slate-400 font-bold uppercase mb-1">Média por Sessão</p>
                        <p class="text-2xl font-bold text-slate-800" id="fin-average-per-session">R$ 0,00</p>
                        <p class="text-xs text-slate-500 mt-1">Valores recebidos</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-sm">Histórico de Receita</h3>
                        <select id="financial-period" onchange="renderFinancial()" class="text-sm border border-slate-200 rounded-lg px-3 py-1 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                            <option value="month">Este mês</option>
                            <option value="quarter">Últimos 3 meses</option>
                            <option value="semester">Últimos 6 meses</option>
                            <option value="year" selected>Últimos 12 meses</option>
                        </select>
                    </div>
                    <div id="fin-history" class="divide-y divide-slate-100">
                        <!-- Financial history will be populated here -->
                        <div class="p-4 text-center text-slate-500">
                            Carregando dados financeiros...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reports Tab -->
            <div id="tab-reports" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-6">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-bold text-lg text-slate-800 mb-1">Relatórios de Atendimento</h3>
                        <p class="text-sm text-slate-500">Visualize dados detalhados sobre seu atendimento</p>
                    </div>
                    <div class="p-5 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h4 class="font-bold text-slate-700 mb-2">Período</h4>
                            <div class="flex gap-2">
                                <input type="date" id="report-start-date" class="input-field text-sm py-2">
                                <input type="date" id="report-end-date" class="input-field text-sm py-2">
                            </div>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h4 class="font-bold text-slate-700 mb-2">Tipo de Relatório</h4>
                            <select id="report-type" class="input-field text-sm py-2">
                                <option value="attendance">Atendimentos</option>
                                <option value="revenue">Financeiro</option>
                                <option value="clients">Pacientes</option>
                                <option value="cancellations">Cancelamentos</option>
                            </select>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-4 flex items-end">
                            <button onclick="generateReport()" class="w-full bg-teal-600 text-white font-bold py-2.5 rounded-lg shadow-lg hover:bg-teal-700 transition flex items-center justify-center">
                                <i class="fa-solid fa-chart-bar mr-2"></i> Gerar Relatório
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="report-results" class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-bold text-lg text-slate-800">Resultados do Relatório</h3>
                    </div>
                    <div class="p-5">
                        <div class="empty-state">
                            <i class="fa-regular fa-file-lines text-slate-300"></i>
                            <h4 class="font-bold text-lg text-slate-700">Nenhum relatório gerado</h4>
                            <p class="text-slate-500">Selecione um período e tipo de relatório para visualizar os dados detalhados</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content hidden">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 space-y-6">
                    <div>
                        <h3 class="font-bold text-slate-800 text-sm border-b border-slate-100 pb-2 mb-4">Configurações Gerais</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Nome do Profissional</label>
                                <input type="text" id="setting-professional-name" placeholder="Seu nome completo" class="input-field">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Registro Profissional (CRP)</label>
                                <input type="text" id="setting-crp" placeholder="CRP 06/12345" class="input-field">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Especialidades (separadas por vírgula)</label>
                                <input type="text" id="setting-specialties" placeholder="Ansiedade, Depressão, Autoconhecimento" class="input-field">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Valor da Sessão (R$)</label>
                                <input type="number" id="setting-session-value" placeholder="150.00" class="input-field">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Duração da Sessão (min)</label>
                                <input type="number" id="setting-session-duration" placeholder="50" class="input-field">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Horário Comercial (Dias)</label>
                                <div class="grid grid-cols-7 gap-2 mt-2">
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="day-sun" class="form-checkbox h-4 w-4 text-teal-600">
                                        <span class="text-[10px] mt-1">Dom</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="day-mon" class="form-checkbox h-4 w-4 text-teal-600" checked>
                                        <span class="text-[10px] mt-1">Seg</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="day-tue" class="form-checkbox h-4 w-4 text-teal-600" checked>
                                        <span class="text-[10px] mt-1">Ter</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="day-wed" class="form-checkbox h-4 w-4 text-teal-600" checked>
                                        <span class="text-[10px] mt-1">Qua</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="day-thu" class="form-checkbox h-4 w-4 text-teal-600" checked>
                                        <span class="text-[10px] mt-1">Qui</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="day-fri" class="form-checkbox h-4 w-4 text-teal-600" checked>
                                        <span class="text-[10px] mt-1">Sex</span>
                                    </label>
                                    <label class="flex flex-col items-center">
                                        <input type="checkbox" id="day-sat" class="form-checkbox h-4 w-4 text-teal-600">
                                        <span class="text-[10px] mt-1">Sáb</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-bold text-slate-800 text-sm border-b border-slate-100 pb-2 mb-4">Automação WhatsApp</h3>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Mensagem de Confirmação</label>
                            <textarea id="setting-msg-confirm" rows="3" class="input-field text-xs" placeholder="Olá {nome}, confirmo seu agendamento para o dia {data} às {hora}.">{nome}, confirmamos seu agendamento para {data} às {hora}. Não esqueça de levar sua carteirinha do plano de saúde.</textarea>
                            <p class="text-[10px] text-slate-400 mt-1">Variáveis disponíveis: {nome}, {data}, {hora}, {valor}</p>
                        </div>
                        <div class="mt-4">
                            <label class="block text-xs font-bold text-slate-500 mb-1">Mensagem de Lembrete (24h antes)</label>
                            <textarea id="setting-msg-reminder" rows="3" class="input-field text-xs" placeholder="Olá {nome}, lembrando do nosso agendamento amanhã ({data}) às {hora}.">{nome}, apenas um lembrete sobre nossa sessão amanhã ({data}) às {hora}. Estou ansioso para nosso encontro!</textarea>
                            <p class="text-[10px] text-slate-400 mt-1">Variáveis disponíveis: {nome}, {data}, {hora}</p>
                        </div>
                        <div class="mt-4">
                            <label class="block text-xs font-bold text-slate-500 mb-1">Link da Vídeo Chamada</label>
                            <input type="text" id="setting-video-link" placeholder="https://meet.google.com/..." class="input-field" value="https://meet.google.com/psipro-consulta">
                        </div>
                    </div>
                    
                    <button onclick="saveSettings()" class="w-full bg-teal-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-teal-500/20 hover:bg-teal-700 transition active:scale-95">
                        <i class="fa-solid fa-save mr-2"></i> Salvar Todas as Configurações
                    </button>
                </div>
                
                <div class="mt-6 bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-800 text-sm border-b border-slate-100 pb-2 mb-4">Backup & Dados</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="exportAllData()" class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-slate-300 rounded-xl hover:border-teal-500 hover:bg-teal-50/50 transition">
                            <i class="fa-solid fa-download text-3xl text-teal-600 mb-2"></i>
                            <span class="font-medium text-slate-700">Exportar Dados</span>
                            <span class="text-xs text-slate-500 mt-1">Backup completo de todos os dados</span>
                        </button>
                        <button onclick="importData()" class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-slate-300 rounded-xl hover:border-amber-500 hover:bg-amber-50/50 transition">
                            <i class="fa-solid fa-upload text-3xl text-amber-600 mb-2"></i>
                            <span class="font-medium text-slate-700">Importar Dados</span>
                            <span class="text-xs text-slate-500 mt-1">Restaurar backup anterior</span>
                        </button>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="resetApp()" class="text-red-500 text-sm font-bold hover:underline flex items-center justify-center">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> Resetar Dados do Aplicativo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-message-selection" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg text-gray-900">Enviar Mensagem</h3>
            <button onclick="closeModal('modal-message-selection')" class="w-8 h-8 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 transition">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <p class="text-sm text-gray-600 mb-6">Escolha o tipo de mensagem que deseja enviar para o paciente via WhatsApp:</p>
        
        <div class="space-y-3">
            <button onclick="sendMessage('confirm')" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl hover:bg-teal-700 transition flex items-center justify-center">
                <i class="fa-solid fa-check-circle mr-2"></i> Confirmação de Agendamento
            </button>
            <button onclick="sendMessage('reminder')" class="w-full bg-amber-500 text-white font-bold py-3 rounded-xl hover:bg-amber-600 transition flex items-center justify-center">
                <i class="fa-solid fa-bell mr-2"></i> Lembrete de Sessão
            </button>
        </div>
    </div>
</div>

    <div id="modal-bulk-generate" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-bold text-lg text-gray-900">Gerar Horários</h3>
      <button onclick="closeModal('modal-bulk-generate')" class="w-8 h-8 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 transition">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>
    <div class="bg-blue-50 p-3 rounded-lg mb-4">
      <p class="text-sm text-blue-700 flex items-start">
        <i class="fa-solid fa-circle-info mt-1 mr-2"></i>
        <span id="bulk-generate-message">Você está prestes a gerar horários para este período. Selecione a opção abaixo para aplicar aos próximos dias úteis.</span>
      </p>
    </div>
    <div class="mb-6">
      <label class="flex items-start cursor-pointer">
        <div class="flex items-center h-5">
          <input type="checkbox" id="apply-to-all-days" class="form-checkbox h-4 w-4 text-teal-600 rounded">
        </div>
        <div class="ml-3 text-sm">
          <span class="font-medium text-gray-700">Aplicar para todos os dias úteis</span>
          <p class="text-xs text-gray-500 mt-1">Esta ação adicionará horários nos próximos 30 dias úteis (segunda a sexta-feira), respeitando seu horário comercial configurado.</p>
        </div>
      </label>
    </div>
    <button onclick="confirmBulkGenerate()" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl hover:bg-teal-700 transition flex items-center justify-center">
      <i class="fa-solid fa-check mr-2"></i> Confirmar Geração
    </button>
  </div>
    </div>
    <div id="modal-booking" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-gray-900">Finalizar Agendamento</h3>
                <button onclick="closeModal('modal-booking')" class="w-8 h-8 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <form onsubmit="confirmBooking(event)" class="space-y-4">
                <input type="text" id="book-name" placeholder="Seu Nome Completo" required class="input-field">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="tel" id="book-phone" placeholder="Seu WhatsApp (11) 99999-9999" required class="input-field" maxlength="15">
                    <input type="email" id="book-email" placeholder="Seu E-mail (opcional)" class="input-field">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Como conheceu o profissional?</label>
                    <select id="book-source" class="input-field">
                        <option value="indication">Indicação</option>
                        <option value="google">Google</option>
                        <option value="instagram">Instagram</option>
                        <option value="facebook">Facebook</option>
                        <option value="other">Outro</option>
                    </select>
                </div>
                
                <div class="bg-blue-50 p-3 rounded-xl flex gap-3">
                    <i class="fa-solid fa-circle-info text-blue-600 mt-0.5"></i>
                    <p class="text-xs text-blue-800">Ao confirmar, você receberá os detalhes da sessão via WhatsApp e e-mail (se informado).</p>
                </div>
                
                <button type="submit" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl hover:bg-black transition active:scale-[0.98] flex justify-center items-center gap-2">
                    <i class="fa-solid fa-check"></i> Solicitar Agendamento
                </button>
            </form>
        </div>
    </div>

    <div id="modal-day" class="modal-overlay hidden">
        <div class="modal-content h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 id="modal-day-title" class="font-bold text-xl text-slate-800">--</h3>
                    <p id="modal-day-date" class="text-xs text-slate-500 flex items-center">
                        <i class="fa-regular fa-calendar-days mr-1 text-slate-400"></i>
                        <span>Gerenciar Dia</span>
                    </p>
                </div>
                <button onclick="closeModal('modal-day')" class="w-8 h-8 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="flex border-b border-slate-100 mb-4">
                <button onclick="switchDayTab('slots')" id="btn-tab-day-slots" class="flex-1 pb-2 text-sm font-bold text-teal-600 border-b-2 border-teal-600">
                    <i class="fa-regular fa-clock mr-1"></i> Horários
                </button>
                <button onclick="switchDayTab('bookings')" id="btn-tab-day-bookings" class="flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent">
                    <i class="fa-solid fa-calendar-check mr-1"></i> Agendamentos
                </button>
            </div>
            
            <div id="day-content-slots" class="flex-1 overflow-y-auto">
                <div class="bg-slate-50 p-3 rounded-xl mb-4 border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2 flex items-center">
                        <i class="fa-solid fa-bolt mr-1 text-amber-500"></i> Gerador Rápido de Horários
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <button onclick="bulkGenerate('morning')" class="bg-white border border-slate-200 text-xs py-2.5 rounded-lg hover:border-teal-500 hover:text-teal-600 transition flex items-center justify-center">
                            <i class="fa-solid fa-sun mr-1"></i> Manhã (08-12h)
                        </button>
                        <button onclick="bulkGenerate('afternoon')" class="bg-white border border-slate-200 text-xs py-2.5 rounded-lg hover:border-teal-500 hover:text-teal-600 transition flex items-center justify-center">
                            <i class="fa-solid fa-cloud-sun mr-1"></i> Tarde (13-18h)
                        </button>
                        <button onclick="bulkGenerate('evening')" class="bg-white border border-slate-200 text-xs py-2.5 rounded-lg hover:border-teal-500 hover:text-teal-600 transition flex items-center justify-center">
                            <i class="fa-solid fa-moon mr-1"></i> Noite (19-21h)
                        </button>
                        <button onclick="bulkGenerate('all')" class="bg-white border border-slate-200 text-xs py-2.5 rounded-lg hover:border-teal-500 hover:text-teal-600 transition flex items-center justify-center">
                            <i class="fa-solid fa-business-time mr-1"></i> Dia Todo
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <input type="time" id="new-slot-time" class="input-field py-2 flex-1">
                    <button onclick="addSlot()" class="bg-teal-600 text-white px-4 rounded-xl shadow-lg shadow-teal-500/30 hover:bg-teal-700 transition">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                
                <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center">
                    <i class="fa-solid fa-list-check mr-2 text-teal-600"></i> Horários Disponíveis
                </h4>
                
                <div id="admin-slots-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                    <!-- Slots will be populated here -->
                    <div class="text-center py-4 text-slate-500">
                        Nenhum horário cadastrado para este dia
                    </div>
                </div>
            </div>
            
            <div id="day-content-bookings" class="hidden flex-1 overflow-y-auto space-y-3">
                <!-- Bookings will be populated here -->
                <div class="text-center py-6 text-slate-500">
                    Nenhum agendamento para este dia
                </div>
            </div>
        </div>
    </div>

    <div id="modal-notes" class="modal-overlay hidden">
        <div class="modal-content h-[70vh] flex flex-col">
            <div class="mb-2 bg-slate-50 p-3 rounded-lg flex items-start">
    <i class="fa-solid fa-circle-info text-slate-400 mt-1 mr-2"></i>
    <p class="text-[11px] text-slate-600">
        As anotações são confidenciais. Use o microfone para ditar e o botão de "Magia AI" para formatar o texto automaticamente.
    </p>
</div>

<div class="flex gap-2 mb-2">
    <button id="btn-record" onclick="toggleRecording()" class="flex-1 bg-red-50 text-red-600 border border-red-100 font-bold py-2 rounded-xl hover:bg-red-100 transition flex items-center justify-center gap-2">
        <i class="fa-solid fa-microphone"></i> <span id="record-text">Gravar Áudio</span>
    </button>
    <button onclick="generateSmartSummary()" class="flex-1 bg-indigo-50 text-indigo-600 border border-indigo-100 font-bold py-2 rounded-xl hover:bg-indigo-100 transition flex items-center justify-center gap-2">
        <i class="fa-solid fa-wand-magic-sparkles"></i> Organizar com IA
    </button>
</div>

<textarea id="client-notes-area" class="flex-1 input-field mb-4 resize-none p-4 leading-relaxed" placeholder="Comece a digitar ou clique em gravar para falar..."></textarea>
    
    <div id="modal-new-client" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-gray-900">Novo Paciente</h3>
                <button onclick="closeModal('modal-new-client')" class="w-8 h-8 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <form onsubmit="saveNewClient(event)" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" id="client-name" placeholder="Nome Completo*" required class="input-field">
                    <input type="tel" id="client-phone" placeholder="WhatsApp* (11) 99999-9999" required class="input-field" maxlength="15">
                    <input type="email" id="client-email" placeholder="E-mail" class="input-field">
                    <input type="date" id="client-birthdate" class="input-field">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Motivo da Consulta</label>
                    <textarea id="client-reason" rows="2" class="input-field text-sm" placeholder="Ansiedade, depressão, dificuldades no trabalho..."></textarea>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Histórico Médico</label>
                    <textarea id="client-medical-history" rows="2" class="input-field text-sm" placeholder="Medicações, condições pré-existentes, alergias..."></textarea>
                </div>
                
                <button type="submit" class="w-full bg-teal-600 text-white font-bold py-4 rounded-xl hover:bg-teal-700 transition active:scale-[0.98] flex justify-center items-center gap-2">
                    <i class="fa-solid fa-user-plus"></i> Cadastrar Paciente
                </button>
            </form>
        </div>
    </div>
    
    <div id="modal-reminder" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-gray-900">Enviar Lembrete</h3>
                <button onclick="closeModal('modal-reminder')" class="w-8 h-8 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <p class="mb-4 text-gray-600" id="reminder-text">Você está prestes a enviar um lembrete para este paciente sobre sua sessão.</p>
            <div class="bg-blue-50 p-3 rounded-lg mb-4">
                <p class="text-xs text-blue-800 flex items-start">
                    <i class="fa-solid fa-circle-info mt-1 mr-2"></i> O lembrete será enviado automaticamente 24 horas antes do agendamento com a mensagem configurada nas suas preferências.
                </p>
            </div>
            <button onclick="sendReminderManually()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-xl transition flex items-center justify-center">
                <i class="fa-solid fa-bell mr-2"></i> Enviar Lembrete Agora
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB9SL_ti3Zc0KUxUAmJylZ0WGgSK56258s",
            authDomain: "psipro-78ae1.firebaseapp.com",
            projectId: "psipro-78ae1",
            storageBucket: "psipro-78ae1.firebasestorage.app",
            messagingSenderId: "688675443489",
            appId: "1:688675443489:web:1d4292fbfdf7ebee9da460"
        };
        
        // Inicialização do Firebase
        let db, storage;
        let loadingData = false;
        let clientsLoaded = 0;
        const clientsPerPage = 10;
        
        try {
            // Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

// Initialize Firestore with emulator settings if needed
const app = firebase.apps[0];

// Get a reference to the service
db = app.firestore();
storage = app.storage();

// Disable deprecated features
db.settings({ ignoreUndefinedProperties: true });
console.log("Firebase initialized successfully");
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showToast("Erro ao conectar com o banco de dados. Verifique sua conexão com a internet.", "error");
        }
        
        // Estado da aplicação
        const DB_PREFIX = 'psi_app_v3_';
        let state = {
            currentDate: new Date(),
            selectedDate: null, // YYYY-MM-DD
            adminDate: new Date(),
            selectedSlot: null,
            settings: null,
            currentUser: null,
            professional: {
                name: "Vinicius Ravagnani",
                registration: "CRP 06/12345",
                specialties: ["Terapia Cognitivo-Comportamental", "Ansiedade", "Autoconhecimento"],
                sessionValue: 150,
                sessionDuration: 50
            },
            view: "view-profile"
        };
        
        // Cache para performance
        let cache = {
            slots: {},
            bookings: [],
            clients: {},
            notes: {},
            lastUpdated: null
        };
        
        //--- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check URL parameters for admin view
            const urlParams = new URLSearchParams(window.location.search);
            state.view = urlParams.get('view') === 'admin' ? 'view-admin' : 'view-profile';
            
            initApp();
        });
        
        async function initApp() {
            showLoader(true);
            
            try {
                // Carregar configurações do Firebase
                await loadSettings();
                
                // Definir data atual como padrão
                const todayISO = new Date().toISOString().split('T')[0];
                state.selectedDate = todayISO;
                
                // Carregar dados iniciais
                await Promise.all([
                    loadSlotsCache(),
                    loadBookingsCache(),
                    loadClientsCache()
                ]);
                
                // Renderizar interface inicial
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(state.view).classList.add('active');
                
                if (state.view === 'view-admin') {
                    renderAdminCalendar();
                    updateDashboard();
                    setupDataRefresh();
                } else {
                    renderClientDates();
                    renderClientSlots();
                }
                
                console.log("App initialized successfully");
            } catch (error) {
                console.error("Error initializing app:", error);
                showToast("Erro ao carregar os dados. Tente novamente mais tarde.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        async function loadSettings() {
            try {
                const settingsDoc = await db.collection('settings').doc('main').get();
                if (settingsDoc.exists) {
                    state.settings = settingsDoc.data();
                } else {
                    // Configurações padrão
                    state.settings = {
                        confirmMsg: "Olá {nome}, confirmo seu agendamento para o dia {data} às {hora}. Valor: R$ {valor}.",
                        reminderMsg: "Olá {nome}, lembrando do nosso agendamento amanhã ({data}) às {hora}.",
                        videoLink: "https://meet.google.com/psipro-consulta",
                        professionalName: "Vinicius Ravagnani",
                        crp: "CRP 06/12345",
                        specialties: "Terapia Cognitivo-Comportamental, Ansiedade, Autoconhecimento",
                        sessionValue: 150,
                        sessionDuration: 50,
                        workingDays: ["mon", "tue", "wed", "thu", "fri"],
                        createdAt: new Date(),
                        updatedAt: new Date()
                    };
                    
                    // Salvar configurações padrão no Firebase
                    await db.collection('settings').doc('main').set(state.settings);
                }
                
                // Atualizar UI com as configurações
                document.getElementById('setting-msg-confirm').value = state.settings.confirmMsg || "Olá {nome}, confirmo seu agendamento para o dia {data} às {hora}.";
                document.getElementById('setting-msg-reminder').value = state.settings.reminderMsg || "Olá {nome}, lembrando do nosso agendamento amanhã ({data}) às {hora}.";
                document.getElementById('setting-video-link').value = state.settings.videoLink || "https://meet.google.com/psipro-consulta";
                document.getElementById('setting-professional-name').value = state.settings.professionalName || "Vinicius Ravagnani";
                document.getElementById('setting-crp').value = state.settings.crp || "CRP 06/12345";
                document.getElementById('setting-specialties').value = state.settings.specialties || "Terapia Cognitivo-Comportamental, Ansiedade, Autoconhecimento";
                document.getElementById('setting-session-value').value = state.settings.sessionValue || 150;
                document.getElementById('setting-session-duration').value = state.settings.sessionDuration || 50;
                
                // Configurar dias úteis
                document.querySelectorAll('#tab-settings input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                (state.settings.workingDays || []).forEach(day => {
                    const checkbox = document.getElementById(`day-${day}`);
                    if (checkbox) checkbox.checked = true;
                });
                
                // Atualizar informações do profissional SOMENTE se os elementos existirem
if (state.settings.professionalName) {
const profileTitle = document.querySelector('#view-profile h1');
const profileSubtitle = document.querySelector('#view-profile .text-blue-600');
if (profileTitle) profileTitle.innerText = state.settings.professionalName;
if (profileSubtitle) profileSubtitle.innerHTML = `${state.settings.professionalName.split(' ')[0]} &bull; ${state.settings.crp}`;
}
if (state.settings.sessionValue) {
const sessionValueElement = document.querySelector('#view-profile .text-lg.font-bold.text-blue-700');
const confirmBarValue = document.querySelector('#client-confirm-bar .text-sm.font-bold.text-blue-600');
if (sessionValueElement) sessionValueElement.innerText = `R$ ${state.settings.sessionValue}`;
if (confirmBarValue) confirmBarValue.innerText = `R$ ${state.settings.sessionValue},00`;
}
if (state.settings.specialties) {
const specialtiesContainer = document.querySelector('#view-profile .flex.flex-wrap.gap-2');
if (specialtiesContainer) {
specialtiesContainer.innerHTML = '';
state.settings.specialties.split(',').map(s => s.trim()).forEach(specialty => {
specialtiesContainer.innerHTML += `
<span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">${specialty}</span>
`;
});
}
}
            } catch (error) {
                console.error("Error loading settings:", error);
                showToast("Erro ao carregar configurações do sistema.", "error");
            }
        }
        
        async function loadSlotsCache() {
            try {
                const slotsSnapshot = await db.collection('slots').get();
                cache.slots = {};
                
                slotsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = doc.id;
                    cache.slots[date] = data.times || [];
                });
                
                console.log("Slots cache loaded:", Object.keys(cache.slots).length, "dates");
            } catch (error) {
                console.error("Error loading slots cache:", error);
                showToast("Erro ao carregar horários disponíveis.", "error");
            }
        }
        
        async function loadBookingsCache() {
            try {
                const bookingsSnapshot = await db.collection('bookings')
                    .orderBy('date', 'desc')
                    .limit(100)
                    .get();
                
                cache.bookings = [];
                bookingsSnapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    cache.bookings.push(data);
                });
                
                console.log("Bookings cache loaded:", cache.bookings.length, "bookings");
            } catch (error) {
                console.error("Error loading bookings cache:", error);
                showToast("Erro ao carregar agendamentos.", "error");
            }
        }
        
        async function loadClientsCache() {
            try {
                const clientsSnapshot = await db.collection('clients').limit(50).get();
                cache.clients = {};
                
                clientsSnapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    cache.clients[data.phone] = data;
                });
                
                console.log("Clients cache loaded:", Object.keys(cache.clients).length, "clients");
            } catch (error) {
                console.error("Error loading clients cache:", error);
                showToast("Erro ao carregar dados dos pacientes.", "error");
            }
        }
        function switchTab(tabId) {
    // Remover a classe 'active' de todas as abas
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Adicionar a classe 'active' à aba selecionada
    document.querySelector(`button[data-tab="${tabId}"]`).classList.add('active');
    
    // Esconder todos os conteúdos das abas
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Mostrar o conteúdo da aba selecionada
    document.getElementById(`tab-${tabId}`).classList.remove('hidden');
    
    // Atualizar conteúdo específico de cada aba
    if (tabId === 'dashboard') updateDashboard();
    if (tabId === 'calendar') renderAdminCalendar();
    if (tabId === 'clients') renderClients();
    if (tabId === 'financial') renderFinancial();
    if (tabId === 'reports') {
        document.getElementById('report-results').querySelector('.empty-state').style.display = 'block';
        document.getElementById('report-results').querySelector('table')?.remove();
    }
}
        function showLoader(show) {
            const loader = document.querySelector('.loader');
            if (loader) {
                loader.style.display = show ? 'inline-block' : 'none';
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function setupDataRefresh() {
            // Atualizar dados a cada 30 segundos
            setInterval(async () => {
                if (!loadingData) {
                    loadingData = true;
                    try {
                        await Promise.all([
                            loadSlotsCache(),
                            loadBookingsCache(),
                            loadClientsCache()
                        ]);
                        if (document.getElementById('tab-dashboard').classList.contains('block')) {
                            updateDashboard();
                        }
                        if (document.getElementById('tab-calendar').classList.contains('block')) {
                            renderAdminCalendar();
                        }
                        console.log("Data refreshed at", new Date().toLocaleTimeString());
                    } catch (error) {
                        console.error("Error refreshing ", error);
                    } finally {
                        loadingData = false;
                    }
                }
            }, 30000);
        }

        //--- NAVEGAÇÃO ---
        function navigateTo(viewId) {
            if (viewId === 'view-admin') {
                // Redirect to admin URL without reloading the page
                window.history.pushState({}, '', '?view=admin');
                state.view = 'view-admin';
            } else {
                // Redirect to main view
                window.history.pushState({}, '', window.location.pathname);
                state.view = 'view-profile';
            }
            
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            window.scrollTo(0, 0);
            
            if (viewId === 'view-admin') {
                renderAdminCalendar();
                updateDashboard();
            }
        }
        
        function navigateToTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[data-tab="${tabId}"]`).classList.add('active');
            
            // Conteúdo
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            
            // Atualizar conteúdo específico de cada aba
            if (tabId === 'dashboard') updateDashboard();
            if (tabId === 'calendar') renderAdminCalendar();
            if (tabId === 'clients') renderClients();
            if (tabId === 'financial') renderFinancial();
            if (tabId === 'reports') {
                // Limpar resultados anteriores
                document.getElementById('report-results').querySelector('.empty-state').style.display = 'block';
                document.getElementById('report-results').querySelector('table')?.remove();
            }
        }
        function navigateToTab(tabId) {
    switchTab(tabId);
}
        function checkAdmin() {
            // Redirecionar para URL de admin sem pedir senha
            navigateTo('view-admin');
        }
        
        function logoutAdmin() {
            // Redirecionar para URL principal
            window.history.pushState({}, '', window.location.pathname);
            state.view = 'view-profile';
            navigateTo('view-profile');
            showToast("Você saiu do painel administrativo.");
        }

        //--- CLIENT VIEW FUNCTIONS ---
        function clientChangeDate(days) {
            const current = new Date(state.selectedDate + 'T00:00:00');
            current.setDate(current.getDate() + days);
            state.selectedDate = current.toISOString().split('T')[0];
            renderClientDates();
            renderClientSlots();
        }
        
        function setClientDate(dateIso) {
            state.selectedDate = dateIso;
            renderClientDates();
            renderClientSlots();
        }
        
        function renderClientDates() {
            const container = document.getElementById('client-date-scroll');
            const monthDisplay = document.getElementById('client-month-display');
            container.innerHTML = '';
            
            const baseDate = new Date(state.selectedDate + 'T00:00:00');
            monthDisplay.innerText = baseDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            // Gerar 7 dias ao redor da data selecionada
            for (let i = -3; i <= 3; i++) {
                const d = new Date(baseDate);
                d.setDate(baseDate.getDate() + i);
                
                const iso = d.toISOString().split('T')[0];
                const dayNum = d.getDate();
                const weekDay = d.toLocaleDateString('pt-BR', { weekday: 'short' }).slice(0, 3);
                
                // Checar disponibilidade
                const allSlots = cache.slots[iso] || [];
                const bookings = cache.bookings.filter(b => b.date === iso).map(b => b.time);
                const available = allSlots.filter(s => !bookings.includes(s)).length > 0;
                
                const dayOfWeek = d.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                const btn = document.createElement('div');
                btn.className = `calendar-day flex-shrink-0 w-14 h-16 border ${iso === state.selectedDate ? 'selected' : isWeekend ? 'bg-rose-50 border-rose-200' : 'bg-white border-gray-100'} ${available ? 'has-slots' : ''}`;
                btn.onclick = () => setClientDate(iso);
                btn.innerHTML = `
                    <span class="text-[10px] uppercase ${isWeekend ? 'text-rose-500' : 'opacity-60'}">${weekDay}</span>
                    <span class="text-xl font-medium">${dayNum}</span>
                `;
                container.appendChild(btn);
            }
        }
        
        function renderClientSlots() {
            const grid = document.getElementById('client-slots-grid');
            const empty = document.getElementById('client-empty-state');
            const confirmBar = document.getElementById('client-confirm-bar');
            
            grid.innerHTML = '';
            state.selectedSlot = null;
            confirmBar.classList.remove('translate-y-0');
            confirmBar.classList.add('translate-y-full');
            
            // Formatar a data para buscar no cache
            const today = new Date().toISOString().split('T')[0];
            const isPastDate = state.selectedDate < today;
            
            if (isPastDate) {
                empty.classList.remove('hidden');
                empty.innerHTML = `
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-400">
                        <i class="fa-regular fa-calendar-days text-2xl"></i>
                    </div>
                    <p class="text-gray-500 text-sm">Não é possível agendar em datas passadas.</p>
                `;
                return;
            }
            
            const allSlots = cache.slots[state.selectedDate] || [];
            const bookings = cache.bookings.filter(b => b.date === state.selectedDate).map(b => b.time);
            
            // Ordenar horários
            allSlots.sort();
            
            if (allSlots.length === 0 || allSlots.length === bookings.length) {
                empty.classList.remove('hidden');
                if (allSlots.length === 0) {
                    empty.querySelector('i').className = 'fa-regular fa-calendar-plus text-2xl';
                    empty.querySelector('p').innerText = 'Não há horários cadastrados para esta data.';
                } else {
                    empty.querySelector('i').className = 'fa-regular fa-calendar-xmark text-2xl';
                    empty.querySelector('p').innerText = 'Todos os horários já foram agendados.';
                }
                return;
            }
            
            empty.classList.add('hidden');
            
            allSlots.forEach(time => {
                const isBooked = bookings.includes(time);
                const btn = document.createElement('button');
                btn.className = `time-slot p-3 rounded-xl font-medium text-sm text-center transition-all duration-200 ${isBooked ? 'booked' : 'bg-white text-gray-700 hover:border-teal-500 hover:shadow-sm'}`;
                btn.innerText = time;
                
                if (!isBooked) {
                    btn.onclick = () => selectSlot(btn, time);
                }
                
                grid.appendChild(btn);
            });
        }
        
        function selectSlot(el, time) {
            document.querySelectorAll('.time-slot').forEach(t => {
                t.classList.remove('selected', 'bg-teal-600', 'text-white', 'border-teal-600');
            });
            
            el.classList.add('selected');
            state.selectedSlot = time;
            
            const date = new Date(state.selectedDate + 'T00:00:00');
            const dateFmt = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            document.getElementById('client-selected-info').innerText = `${dateFmt} às ${time}`;
            
            document.getElementById('client-confirm-bar').classList.remove('translate-y-full');
            document.getElementById('client-confirm-bar').classList.add('translate-y-0');
        }
        
        function openBookingModal() {
            document.getElementById('modal-booking').classList.remove('hidden');
            document.getElementById('book-name').value = '';
            document.getElementById('book-phone').value = '';
            document.getElementById('book-email').value = '';
            document.getElementById('book-source').value = 'indication';
        }
        
        async function confirmBooking(e) {
            e.preventDefault();
            
            const name = document.getElementById('book-name').value.trim();
            let phone = document.getElementById('book-phone').value.trim();
            const email = document.getElementById('book-email').value.trim();
            const source = document.getElementById('book-source').value;
            
            // Formatar o telefone para o padrão brasileiro
            phone = phone.replace(/\D/g, '');
            if (phone.length === 10) {
                phone = phone.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else if (phone.length === 11) {
                phone = phone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            
            if (!name || !phone) {
                showToast("Por favor, preencha todos os campos obrigatórios.", "error");
                return;
            }
            
            if (!validatePhone(phone)) {
                showToast("Número de WhatsApp inválido. Use o formato (11) 99999-9999", "error");
                return;
            }
            
            showLoader(true);
            
            try {
                const formattedPhone = formatPhone(phone);
                const value = state.settings?.sessionValue || 150;
                
                // Verificar se cliente já existe
                let clientData = cache.clients[formattedPhone];
                
                if (!clientData) {
                    // Criar novo cliente
                    clientData = {
                        name: name,
                        phone: formattedPhone,
                        email: email || null,
                        source: source,
                        createdAt: new Date(),
                        updatedAt: new Date(),
                        lastSession: state.selectedDate,
                        totalSessions: 1
                    };
                    
                    // Salvar no Firebase
                    const clientRef = db.collection('clients').doc(formattedPhone);
                    await clientRef.set(clientData);
                    
                    // Adicionar ao cache
                    cache.clients[formattedPhone] = clientData;
                } else {
                    // Atualizar último agendamento e contador de sessões
                    clientData.lastSession = state.selectedDate;
                    clientData.totalSessions = (clientData.totalSessions || 0) + 1;
                    clientData.updatedAt = new Date();
                    
                    await db.collection('clients').doc(formattedPhone).update({
                        lastSession: state.selectedDate,
                        totalSessions: firebase.firestore.FieldValue.increment(1),
                        updatedAt: new Date()
                    });
                }
                
                // Criar novo agendamento
                const bookingId = db.collection('bookings').doc().id;
                const bookingData = {
                    id: bookingId,
                    date: state.selectedDate,
                    time: state.selectedSlot,
                    clientName: name,
                    clientPhone: formattedPhone,
                    clientEmail: email || null,
                    clientSource: source,
                    value: value,
                    status: 'confirmed',
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    reminderSent: false
                };
                
                // Salvar no Firebase
                await db.collection('bookings').doc(bookingId).set(bookingData);
                
                // Adicionar ao cache
                cache.bookings.unshift(bookingData);
                if (cache.bookings.length > 100) cache.bookings.pop();
                
                // Fechar modal
closeModal('modal-booking');

// Redirecionar para WhatsApp com mensagem formatada após salvar o agendamento
setTimeout(() => {
    // Formatar data para exibição
    const formattedDate = state.selectedDate.split('-').reverse().join('/');
    
    // Montar mensagem para o psicólogo
    const message = `Olá, me chamo ${name}, gostaria de agendar uma sessão para o dia ${formattedDate} às ${state.selectedSlot}.`;
    
    // Codificar a mensagem para URL e redirecionar para WhatsApp
    const encodedMessage = encodeURIComponent(message);
    window.location.href = `https://wa.me/5516991421704?text=${encodedMessage}`;
    
    // Mensagem de sucesso
    showToast("Solicitação enviada com sucesso! Você será redirecionado para o WhatsApp.");
    
    // Atualizar interface depois de um breve delay
    setTimeout(() => {
        renderClientSlots();
        renderClientDates();
        navigateTo('view-profile');
    }, 3000);
}, 500);
            } catch (error) {
                console.error("Error confirming booking:", error);
                showToast("Erro ao solicitar agendamento. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        function validatePhone(phone) {
            // Remover caracteres não numéricos
            const digits = phone.replace(/\D/g, '');
            // Verificar se tem 10 ou 11 dígitos (código do país + DDD + número)
            return digits.length === 10 || digits.length === 11;
        }
        
        function formatPhone(phone) {
            // Remover caracteres não numéricos
            const digits = phone.replace(/\D/g, '');
            
            if (digits.length === 10) {
                return `(${digits.substring(0,2)}) ${digits.substring(2,6)}-${digits.substring(6,10)}`;
            } else if (digits.length === 11) {
                return `(${digits.substring(0,2)}) ${digits.substring(2,7)}-${digits.substring(7,11)}`;
            }
            
            return phone;
        }
        
        //--- ADMIN VIEW FUNCTIONS ---
        function changeAdminMonth(delta) {
            state.adminDate.setMonth(state.adminDate.getMonth() + delta);
            renderAdminCalendar();
        }
        
        async function renderAdminCalendar() {
            const grid = document.getElementById('admin-calendar-grid');
            const title = document.getElementById('admin-calendar-month');
            grid.innerHTML = '<div class="col-span-7 text-center py-8"><div class="loader mx-auto"></div></div>';
            
            const year = state.adminDate.getFullYear();
            const month = state.adminDate.getMonth();
            
            title.innerText = state.adminDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Obter dados para o mês atual
            const monthStart = new Date(year, month, 1).toISOString().split('T')[0];
            const monthEnd = new Date(year, month + 1, 0).toISOString().split('T')[0];
            
            // Filtrar agendamentos do mês atual
            const monthBookings = cache.bookings.filter(b => 
                b.date >= monthStart && b.date <= monthEnd
            );
            
            // Agrupar por data
            const bookingsByDate = {};
            monthBookings.forEach(booking => {
                if (!bookingsByDate[booking.date]) {
                    bookingsByDate[booking.date] = [];
                }
                bookingsByDate[booking.date].push(booking);
            });
            
            // Limpar grid antes de renderizar
            grid.innerHTML = '';
            
            // Adicionar dias vazios no início do mês
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += '<div class="bg-slate-50 h-24"></div>';
            }
            
            // Renderizar dias do mês
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const iso = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                
                const slots = cache.slots[iso] || [];
                const dayBookings = bookingsByDate[iso] || [];
                const today = new Date().toISOString().split('T')[0];
                const isToday = iso === today;
                
                // Determinar status do dia
                let statusClass = 'bg-white text-slate-700';
                let statusText = '';
                
                if (slots.length === 0) {
                    statusClass = 'bg-slate-50 text-slate-400'; // Vazio
                    statusText = 'Sem horários';
                } else if (dayBookings.length >= slots.length) {
                    statusClass = 'bg-red-50 text-red-700'; // Cheio
                    statusText = 'Esgotado';
                } else if (dayBookings.length > 0) {
                    statusClass = 'bg-teal-50 text-teal-700'; // Parcial
                    statusText = `${dayBookings.length}/${slots.length}`;
                } else {
                    statusClass = 'bg-white text-slate-700'; // Disponível
                    statusText = `${slots.length} horários`;
                }
                
                if (isToday) {
                    statusClass += ' border-2 border-teal-500 shadow-sm';
                } else if (isWeekend) {
                    statusClass += ' border border-rose-200 bg-rose-50 text-rose-700';
                } else {
                    statusClass += ' border border-slate-100';
                }
                
                const dayEl = document.createElement('div');
                dayEl.className = `h-24 p-1 cursor-pointer hover:bg-slate-100 transition relative flex flex-col items-center justify-center rounded-lg ${statusClass}`;
                dayEl.onclick = () => openDayModal(iso);
                
                // Determinar cor dos pontos
                let dotColor = '';
                if (dayBookings.length > 0) {
                    if (dayBookings.length >= slots.length) {
                        dotColor = 'bg-red-500'; // Cheio
                    } else {
                        dotColor = 'bg-teal-500'; // Parcial
                    }
                }
                
                dayEl.innerHTML = `
                    <div class="absolute top-1 right-1 flex space-x-0.5">
                        ${isToday ? '<span class="w-1.5 h-1.5 bg-teal-500 rounded-full"></span>' : ''}
                        ${isWeekend ? '<span class="w-1.5 h-1.5 bg-rose-500 rounded-full"></span>' : ''}
                    </div>
                    <span class="text-sm font-medium z-10">${d}</span>
                    ${dayBookings.length > 0 ? `
                        <span class="absolute bottom-1 flex space-x-0.5 z-10">
                            ${Array.from({length: Math.min(3, dayBookings.length)}, (_, i) => 
                                `<span class="w-1 h-1 ${dotColor} rounded-full"></span>`
                            ).join('')}
                            ${dayBookings.length > 3 ? `<span class="w-1 h-1 bg-gray-400 rounded-full"></span>` : ''}
                        </span>
                    ` : ''}
                    <span class="text-[9px] mt-1 opacity-80 z-10">${statusText}</span>
                `;
                
                grid.appendChild(dayEl);
            }
        }
        
        // Funções para o modal do dia
        let currentModalDate = null;
        
        function openDayModal(iso) {
            currentModalDate = iso;
            const date = new Date(iso + 'T00:00:00');
            
            document.getElementById('modal-day-title').innerText = date.getDate();
            document.getElementById('modal-day-date').innerHTML = `
                <i class="fa-regular fa-calendar-days mr-1 text-slate-400"></i>
                ${date.toLocaleDateString('pt-BR', { weekday: 'long', month: 'long' })} de ${date.getFullYear()}
            `;
            
            document.getElementById('modal-day').classList.remove('hidden');
            
            // Default tab
            switchDayTab('slots');
            renderAdminDaySlots();
            renderAdminDayBookings();
        }
        
        function switchDayTab(tab) {
            if (tab === 'slots') {
                document.getElementById('day-content-slots').classList.remove('hidden');
                document.getElementById('day-content-bookings').classList.add('hidden');
                document.getElementById('btn-tab-day-slots').className = "flex-1 pb-2 text-sm font-bold text-teal-600 border-b-2 border-teal-600";
                document.getElementById('btn-tab-day-bookings').className = "flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent";
            } else {
                document.getElementById('day-content-slots').classList.add('hidden');
                document.getElementById('day-content-bookings').classList.remove('hidden');
                document.getElementById('btn-tab-day-slots').className = "flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent";
                document.getElementById('btn-tab-day-bookings').className = "flex-1 pb-2 text-sm font-bold text-teal-600 border-b-2 border-teal-600";
            }
        }
        
        function renderAdminDaySlots() {
            const list = document.getElementById('admin-slots-list');
            list.innerHTML = '<div class="col-span-full text-center py-4"><div class="loader mx-auto"></div></div>';
            
            setTimeout(() => {
                const daySlots = cache.slots[currentModalDate] || [];
                const bookings = cache.bookings.filter(b => b.date === currentModalDate).map(b => b.time);
                
                if (daySlots.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-8 text-slate-500 col-span-full">
                            <i class="fa-regular fa-clock text-3xl opacity-50 mb-2 block"></i>
                            <p>Nenhum horário cadastrado para este dia</p>
                            <p class="text-xs mt-1">Use o gerador rápido ou adicione manualmente</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = '';
                
                daySlots.forEach(time => {
                    const isBooked = bookings.includes(time);
                    const el = document.createElement('div');
                    el.className = `flex items-center justify-between p-2.5 rounded-lg text-xs font-medium border ${isBooked ? 'bg-teal-50 border-teal-200 text-teal-800' : 'bg-white border-slate-200 text-slate-700 hover:border-teal-300'}`;
                    el.innerHTML = `
                        <span class="font-bold">${time}</span>
                        ${!isBooked ? `
                            <button onclick="removeSlot('${time}')" class="text-red-500 hover:text-red-700 transition" title="Remover horário">
                                <i class="fa-solid fa-trash-can text-sm"></i>
                            </button>
                        ` : `
                            <span class="text-green-600 flex items-center">
                                <i class="fa-solid fa-check-circle mr-1"></i> Agendado
                            </span>
                        `}
                    `;
                    list.appendChild(el);
                });
            }, 300);
        }
        
        function renderAdminDayBookings() {
            const container = document.getElementById('day-content-bookings');
            container.innerHTML = '<div class="text-center py-6"><div class="loader mx-auto mb-2"></div><p class="text-slate-500 text-sm">Carregando agendamentos...</p></div>';
            
            setTimeout(() => {
                const bookings = cache.bookings
                    .filter(b => b.date === currentModalDate)
                    .sort((a, b) => a.time.localeCompare(b.time));
                
                if (bookings.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-slate-500">
                            <i class="fa-regular fa-calendar-plus text-3xl opacity-50 mb-2 block"></i>
                            <p class="font-medium">Nenhum agendamento para este dia</p>
                            <p class="text-xs mt-1">Os horários disponíveis aparecerão aqui quando agendados</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                bookings.forEach(booking => {
                    const client = cache.clients[booking.clientPhone] || { name: booking.clientName, email: booking.clientEmail };
                    const isToday = booking.date === new Date().toISOString().split('T')[0];
                    const sessionIsPast = isToday && booking.time < new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    const card = document.createElement('div');
                    card.className = `booking-card bg-white p-4 rounded-xl border border-slate-100 shadow-sm mb-3 ${sessionIsPast ? 'opacity-70 border-l-4 border-l-gray-400' : ''}`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="min-w-0">
                                <div class="flex items-center mb-1">
                                    <span class="bg-teal-100 text-teal-800 text-[11px] font-bold px-2 py-0.5 rounded mr-2">${booking.time}</span>
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">${booking.status === 'confirmed' ? 'Confirmado' : 'Pendente'}</span>
                                </div>
                                <h4 class="font-bold text-slate-800 text-base truncate" title="${client.name}">${client.name}</h4>
                                <div class="flex flex-wrap gap-2 mt-1">
                                    ${client.email ? `<span class="text-[10px] text-slate-500 flex items-center"><i class="fa-solid fa-envelope mr-1 text-slate-400"></i> ${client.email}</span>` : ''}
                                    <span class="text-[10px] text-slate-500 flex items-center">
                                        <i class="fa-solid fa-money-bill mr-1 text-green-500"></i> R$ ${booking.value},00
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col items-end space-y-1">
                                ${!sessionIsPast ? `
                                <button onclick="openReminderModal('${booking.id}', '${client.name}')" class="w-7 h-7 bg-amber-50 text-amber-600 rounded-lg flex items-center justify-center hover:bg-amber-100 transition" title="Enviar lembrete">
                                    <i class="fa-solid fa-bell text-xs"></i>
                                </button>` : ''}
                                <button onclick="deleteBooking('${booking.id}', '${client.name}')" class="w-7 h-7 bg-red-50 text-red-600 rounded-lg flex items-center justify-center hover:bg-red-100 transition" title="Cancelar agendamento">
                                    <i class="fa-solid fa-xmark text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <a href="https://wa.me/55${booking.clientPhone.replace(/\D/g,'')}" target="_blank" class="flex-1 bg-green-50 text-green-700 text-center py-2 rounded-lg text-xs font-medium hover:bg-green-100 transition">
                                <i class="fa-brands fa-whatsapp mr-1"></i> WhatsApp
                            </a>
                            <button onclick="openNotesModal('${booking.clientPhone}', '${client.name}')" class="flex-1 bg-slate-50 text-slate-700 py-2 rounded-lg text-xs font-medium hover:bg-slate-100 transition">
                                <i class="fa-solid fa-file-lines mr-1"></i> Prontuário
                            </button>
                        </div>
                        ${booking.createdAt ? `
                        <div class="mt-3 pt-3 border-t border-slate-100 text-[10px] text-slate-400">
                            <i class="fa-solid fa-clock mr-1"></i> Agendado em: ${new Date(booking.createdAt.toDate()).toLocaleDateString('pt-BR')} às ${new Date(booking.createdAt.toDate()).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                        </div>` : ''}
                    `;
                    container.appendChild(card);
                });
            }, 300);
        }
        
        async function addSlot() {
            const timeInput = document.getElementById('new-slot-time');
            const time = timeInput.value;
            
            if (!time) {
                showToast("Selecione um horário válido", "error");
                return;
            }
            
            // Validar formato do horário
            const [hours, minutes] = time.split(':');
            if (parseInt(hours) < 8 || parseInt(hours) > 21) {
                showToast("Horário fora do período comercial (8h-21h)", "error");
                return;
            }
            
            try {
                showLoader(true);
                
                // Obter slots existentes
                let daySlots = cache.slots[currentModalDate] || [];
                
                // Verificar se o horário já existe
                if (daySlots.includes(time)) {
                    showToast("Este horário já está cadastrado para este dia", "error");
                    return;
                }
                
                // Adicionar novo horário
                daySlots.push(time);
                daySlots.sort();
                
                // Atualizar no Firebase
                await db.collection('slots').doc(currentModalDate).set({
                    times: daySlots,
                    date: currentModalDate,
                    updatedAt: new Date()
                });
                
                // Atualizar cache
                cache.slots[currentModalDate] = daySlots;
                
                // Limpar campo de input
                timeInput.value = '';
                
                // Renderizar novamente
                renderAdminDaySlots();
                renderAdminCalendar();
                
                showToast("Horário adicionado com sucesso!");
            } catch (error) {
                console.error("Error adding slot:", error);
                showToast("Erro ao adicionar horário. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        async function removeSlot(time) {
            if (!confirm(`Tem certeza que deseja remover o horário ${time}? Esta ação não pode ser desfeita.`)) {
                return;
            }
            
            try {
                showLoader(true);
                
                // Verificar se há agendamentos para este horário
                const bookings = cache.bookings.filter(b => 
                    b.date === currentModalDate && b.time === time
                );
                
                if (bookings.length > 0) {
                    if (!confirm(`Existem ${bookings.length} agendamento(s) neste horário. Remover o horário também cancelará estes agendamentos. Deseja continuar?`)) {
                        return;
                    }
                    
                    // Cancelar todos os agendamentos deste horário
                    for (const booking of bookings) {
                        await db.collection('bookings').doc(booking.id).delete();
                        
                        // Remover do cache
                        cache.bookings = cache.bookings.filter(b => b.id !== booking.id);
                    }
                    
                    showToast(`${bookings.length} agendamento(s) cancelado(s) com sucesso!`, "success");
                }
                
                // Remover o horário
                let daySlots = cache.slots[currentModalDate] || [];
                daySlots = daySlots.filter(t => t !== time);
                
                if (daySlots.length > 0) {
                    // Atualizar documento existente
                    await db.collection('slots').doc(currentModalDate).update({
                        times: daySlots,
                        updatedAt: new Date()
                    });
                } else {
                    // Remover documento inteiro se não houver mais horários
                    await db.collection('slots').doc(currentModalDate).delete();
                }
                
                // Atualizar cache
                cache.slots[currentModalDate] = daySlots;
                
                // Renderizar novamente
                renderAdminDaySlots();
                renderAdminCalendar();
                
                showToast("Horário removido com sucesso!");
            } catch (error) {
                console.error("Error removing slot:", error);
                showToast("Erro ao remover horário. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        async function bulkGenerate(period) {
            if (!confirm(`Isso adicionará vários horários para ${period === 'morning' ? 'manhã' : period === 'afternoon' ? 'tarde' : period === 'evening' ? 'noite' : 'o dia todo'}. Deseja continuar?`)) {
                return;
            }
            
            try {
                showLoader(true);
                
                let newSlots = [];
                let daySlots = cache.slots[currentModalDate] || [];
                
                if (period === 'morning' || period === 'all') {
                    // Manhã: 8h às 12h, a cada 50 minutos
                    for (let h = 8; h <= 12; h++) {
                        const timeStr = `${String(h).padStart(2, '0')}:00`;
                        if (!daySlots.includes(timeStr) && !newSlots.includes(timeStr)) {
                            newSlots.push(timeStr);
                        }
                    }
                }
                
                if (period === 'afternoon' || period === 'all') {
                    // Tarde: 13h às 18h, a cada 50 minutos
                    for (let h = 13; h <= 18; h++) {
                        const timeStr = `${String(h).padStart(2, '0')}:00`;
                        if (!daySlots.includes(timeStr) && !newSlots.includes(timeStr)) {
                            newSlots.push(timeStr);
                        }
                    }
                }
                
                if (period === 'evening' || period === 'all') {
                    // Noite: 19h às 21h, a cada 50 minutos
                    for (let h = 19; h <= 21; h++) {
                        const timeStr = `${String(h).padStart(2, '0')}:00`;
                        if (!daySlots.includes(timeStr) && !newSlots.includes(timeStr)) {
                            newSlots.push(timeStr);
                        }
                    }
                }
                
                if (newSlots.length === 0) {
                    showToast("Todos os horários deste período já estão cadastrados.", "error");
                    return;
                }
                
                // Combinar slots existentes com novos slots
                daySlots = [...daySlots, ...newSlots];
                daySlots.sort();
                
                // Atualizar no Firebase
                await db.collection('slots').doc(currentModalDate).set({
                    times: daySlots,
                    date: currentModalDate,
                    updatedAt: new Date()
                });
                
                // Atualizar cache
                cache.slots[currentModalDate] = daySlots;
                
                // Renderizar novamente
                renderAdminDaySlots();
                renderAdminCalendar();
                
                showToast(`${newSlots.length} novos horários adicionados com sucesso!`);
            } catch (error) {
                console.error("Error generating slots:", error);
                showToast("Erro ao gerar horários. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        function bulkGenerate(period) {
  const periodText = period === 'morning' ? 'manhã (08-12h)' : 
                     period === 'afternoon' ? 'tarde (13-18h)' : 
                     period === 'evening' ? 'noite (19-21h)' : 
                     'o dia todo (08-21h)';
  
  const dateObj = new Date(currentModalDate);
  const formattedDate = dateObj.toLocaleDateString('pt-BR');
  
  document.getElementById('bulk-generate-message').innerHTML = 
    `Você está prestes a gerar horários para a ${periodText}.<br><span class="font-medium text-gray-800">Dia selecionado: ${formattedDate}</span>`;
  
  // Armazenar o período selecionado no estado
  state.bulkGeneratePeriod = period;
  
  // Limpar o checkbox
  document.getElementById('apply-to-all-days').checked = false;
  
  // Mostrar o modal
  document.getElementById('modal-bulk-generate').classList.remove('hidden');
}

async function confirmBulkGenerate() {
  const period = state.bulkGeneratePeriod;
  const applyToAllDays = document.getElementById('apply-to-all-days').checked;
  
  try {
    showLoader(true);
    let message;
    
    if (applyToAllDays) {
      message = "Gerando horários para os próximos 30 dias úteis...";
      showToast(message);
      await bulkGenerateForMultipleDays(period);
    } else {
      message = "Gerando horários para o dia selecionado...";
      showToast(message);
      await generateSlotsForSingleDay(period, currentModalDate);
    }
    
    // Atualizar a visualização
    renderAdminDaySlots();
    renderAdminCalendar();
    
    showToast("Horários gerados com sucesso!");
  } catch (error) {
    console.error("Error generating slots:", error);
    showToast("Erro ao gerar horários. Tente novamente.", "error");
  } finally {
    showLoader(false);
  }
}

async function bulkGenerateForMultipleDays(period) {
  const today = new Date();
  const datesToGenerate = [];
  
  // Encontrar os próximos 30 dias úteis
  let daysChecked = 0;
  while (datesToGenerate.length < 30 && daysChecked < 60) { // Limite para evitar loop infinito
    const nextDate = new Date(today);
    nextDate.setDate(today.getDate() + daysChecked + 1);
    
    // Verificar se é dia útil (segunda a sexta)
    const dayOfWeek = nextDate.getDay();
    if (dayOfWeek !== 0 && dayOfWeek !== 6) { // 0 = domingo, 6 = sábado
      datesToGenerate.push(nextDate.toISOString().split('T')[0]);
    }
    
    daysChecked++;
  }
  
  // Gerar horários para cada data
  for (let i = 0; i < datesToGenerate.length; i++) {
    const date = datesToGenerate[i];
    await generateSlotsForSingleDay(period, date);
    
    // Atualizar progresso periodicamente
    if (i % 5 === 0 || i === datesToGenerate.length - 1) {
      showToast(`Progresso: ${i + 1} de ${datesToGenerate.length} dias`);
    }
  }
}

async function generateSlotsForSingleDay(period, date) {
  let newSlots = [];
  let daySlots = cache.slots[date] || [];
  
  if (period === 'morning' || period === 'all') {
    // Manhã: 8h às 12h, a cada hora
    for (let h = 8; h <= 12; h++) {
      const timeStr = `${String(h).padStart(2, '0')}:00`;
      if (!daySlots.includes(timeStr) && !newSlots.includes(timeStr)) {
        newSlots.push(timeStr);
      }
    }
  }
  
  if (period === 'afternoon' || period === 'all') {
    // Tarde: 13h às 18h, a cada hora
    for (let h = 13; h <= 18; h++) {
      const timeStr = `${String(h).padStart(2, '0')}:00`;
      if (!daySlots.includes(timeStr) && !newSlots.includes(timeStr)) {
        newSlots.push(timeStr);
      }
    }
  }
  
  if (period === 'evening' || period === 'all') {
    // Noite: 19h às 21h, a cada hora
    for (let h = 19; h <= 21; h++) {
      const timeStr = `${String(h).padStart(2, '0')}:00`;
      if (!daySlots.includes(timeStr) && !newSlots.includes(timeStr)) {
        newSlots.push(timeStr);
      }
    }
  }
  
  if (newSlots.length === 0) {
    return; // Nada para adicionar
  }
  
  // Combinar slots existentes com novos slots
  daySlots = [...daySlots, ...newSlots];
  daySlots.sort();
  
  // Atualizar no Firebase
  await db.collection('slots').doc(date).set({
    times: daySlots,
    date: date,
    updatedAt: new Date()
  });
  
  // Atualizar cache
  cache.slots[date] = daySlots;
}
        async function deleteBooking(bookingId, clientName) {
            if (!confirm(`Tem certeza que deseja cancelar o agendamento de ${clientName}?`)) {
                return;
            }
            
            try {
                showLoader(true);
                
                // Remover do Firebase
                await db.collection('bookings').doc(bookingId).delete();
                
                // Remover do cache
                cache.bookings = cache.bookings.filter(b => b.id !== bookingId);
                
                // Atualizar contagem de sessões do cliente
                const booking = cache.bookings.find(b => b.id === bookingId);
                if (booking) {
                    const clientPhone = booking.clientPhone;
                    const client = cache.clients[clientPhone];
                    
                    if (client) {
                        client.totalSessions = Math.max(0, (client.totalSessions || 1) - 1);
                        client.updatedAt = new Date();
                        
                        await db.collection('clients').doc(clientPhone).update({
                            totalSessions: client.totalSessions,
                            updatedAt: new Date()
                        });
                    }
                }
                
                // Renderizar novamente
                renderAdminDayBookings();
                renderAdminDaySlots();
                renderAdminCalendar();
                updateDashboard();
                
                showToast("Agendamento cancelado com sucesso!");
            } catch (error) {
                console.error("Error deleting booking:", error);
                showToast("Erro ao cancelar agendamento. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        let currentNoteClient = null;
        let currentNoteClientName = '';
        
        function openNotesModal(phone, name) {
            currentNoteClient = phone;
            currentNoteClientName = name;
            
            document.getElementById('modal-notes').classList.remove('hidden');
            document.getElementById('notes-client-name').innerHTML = `
                <i class="fa-solid fa-user-injured mr-1"></i> <span>${name}</span>
            `;
            
            // Carregar anotações existentes
            loadClientNotes(phone);
        }
        
        async function loadClientNotes(phone) {
            try {
                showLoader(true);
                
                const notesDoc = await db.collection('notes').doc(phone).get();
                const notesArea = document.getElementById('client-notes-area');
                
                if (notesDoc.exists) {
                    const data = notesDoc.data();
                    notesArea.value = data.content || '';
                } else {
                    notesArea.value = '';
                }
            } catch (error) {
                console.error("Error loading notes:", error);
                showToast("Erro ao carregar anotações do paciente.", "error");
                document.getElementById('client-notes-area').value = '';
            } finally {
                showLoader(false);
            }
        }
        
        async function saveNotes() {
            const text = document.getElementById('client-notes-area').value;
            const saveButton = document.querySelector('#modal-notes button');
            const originalText = saveButton.innerHTML;
            
            try {
                showLoader(true);
                saveButton.innerHTML = '<i class="fa-solid fa-spinner animate-spin mr-1"></i> Salvando...';
                
                await db.collection('notes').doc(currentNoteClient).set({
                    clientId: currentNoteClient,
                    clientName: currentNoteClientName,
                    content: text,
                    updatedAt: new Date()
                });
                
                // Atualizar cache
                if (!cache.notes[currentNoteClient]) {
                    cache.notes[currentNoteClient] = {};
                }
                cache.notes[currentNoteClient].content = text;
                cache.notes[currentNoteClient].updatedAt = new Date();
                
                showToast("Anotações salvas com sucesso!");
                
                // Fechar modal após salvar
                setTimeout(() => {
                    closeModal('modal-notes');
                    saveButton.innerHTML = '<i class="fa-solid fa-save mr-1"></i> Salvar Anotação';
                }, 1000);
            } catch (error) {
                console.error("Error saving notes:", error);
                showToast("Erro ao salvar anotações. Tente novamente.", "error");
                saveButton.innerHTML = originalText;
            } finally {
                showLoader(false);
            }
        }
        
        function addNoteTemplate(type) {
            const textarea = document.getElementById('client-notes-area');
            const currentDate = new Date().toLocaleDateString('pt-BR');
            const currentTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            let template = '';
            
            switch(type) {
                case 'initial':
                    template = `DATA: ${currentDate} às ${currentTime}\n\nANAMNESE INICIAL\n\nMotivo da consulta:\n${cache.clients[currentNoteClient]?.reason || ''}\n\nHistórico:\n${cache.clients[currentNoteClient]?.medicalHistory || ''}\n\nDiagnóstico preliminar:\n\nPlano de tratamento:\n\nPróximos passos:\n`;
                    break;
                case 'session':
                    template = `DATA: ${currentDate} às ${currentTime}\n\nSESSÃO\n\nResumo da sessão:\n\nTópicos abordados:\n\nExercícios/Atividades:\n\nPróximos objetivos:\n\nObservações:\n`;
                    break;
                case 'progress':
                    template = `DATA: ${currentDate} às ${currentTime}\n\nEVOLUÇÃO\n\nProgresso desde a última sessão:\n\nDificuldades enfrentadas:\n\nEstratégias utilizadas:\n\nMetas para o próximo período:\n\nAvaliação geral:\n`;
                    break;
            }
            
            if (textarea.value.trim() !== '') {
                textarea.value += '\n\n' + template;
            } else {
                textarea.value = template;
            }
            
            // Posicionar cursor no final do texto
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            textarea.focus();
        }
        
        async function updateDashboard() {
            showLoader(true);
            
            try {
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const currentMonth = now.toISOString().slice(0, 7); // YYYY-MM
                
                // Próximos agendamentos
                const upcoming = cache.bookings
                    .filter(b => {
                        const bookingDateTime = new Date(`${b.date}T${b.time}:00`);
                        return bookingDateTime >= now;
                    })
                    .sort((a, b) => {
                        const dateA = new Date(`${a.date}T${a.time}`);
                        const dateB = new Date(`${b.date}T${b.time}`);
                        return dateA - dateB;
                    });
                
                // Atualizar UI Próximo
                if (upcoming.length > 0) {
                    const next = upcoming[0];
                    const isToday = next.date === today;
                    
                    document.getElementById('dash-next-badge').innerText = isToday ? 'HOJE' : next.date.split('-').reverse().join('/');
                    document.getElementById('dash-next-time').innerText = next.time;
                    document.getElementById('dash-next-client').innerText = next.clientName;
                    
                    // Salvar dados para ações rápidas
                    document.getElementById('dash-next-content').dataset.nextPhone = next.clientPhone;
                    document.getElementById('dash-next-content').dataset.nextName = next.clientName;
                    document.getElementById('dash-next-content').dataset.nextId = next.id;
                } else {
                    document.getElementById('dash-next-time').innerText = "--:--";
                    document.getElementById('dash-next-client').innerText = "Nenhum agendamento futuro";
                    document.getElementById('dash-next-badge').innerText = "";
                }
                
                // Calcular estatísticas
                const uniqueClients = Object.keys(cache.clients).length;
                const monthSessions = cache.bookings.filter(b => b.date.startsWith(currentMonth)).length;
                
                // Calcular receita do mês
                const monthRevenue = cache.bookings
                    .filter(b => b.date.startsWith(currentMonth) && b.status === 'confirmed')
                    .reduce((sum, booking) => sum + (booking.value || 150), 0);
                
                // Calcular disponibilidade (baseado nos últimos 7 dias)
                const last7Days = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    last7Days.push(date.toISOString().split('T')[0]);
                }
                
                let totalSlots = 0;
                let bookedSlots = 0;
                
                last7Days.forEach(date => {
                    const slots = cache.slots[date] || [];
                    const bookings = cache.bookings.filter(b => b.date === date).length;
                    totalSlots += slots.length;
                    bookedSlots += Math.min(bookings, slots.length);
                });
                
                const availability = totalSlots > 0 ? Math.round(((totalSlots - bookedSlots) / totalSlots) * 100) : 0;
                
                // Atualizar UI com estatísticas
                document.getElementById('dash-total-clients').innerText = uniqueClients;
                document.getElementById('dash-month-count').innerText = monthSessions;
                document.getElementById('dash-month-revenue').innerText = monthRevenue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('dash-availability').innerText = `${availability}%`;
                
                // Carregar próximos agendamentos
                loadUpcomingAppointments();
                
                // Carregar últimos clientes
                loadRecentClients();
                
            } catch (error) {
                console.error("Error updating dashboard:", error);
                showToast("Erro ao atualizar o dashboard. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        function loadUpcomingAppointments() {
            const container = document.getElementById('upcoming-appointments');
            container.innerHTML = '';
            
            const now = new Date();
            const next7Days = [];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                next7Days.push(date.toISOString().split('T')[0]);
            }
            
            // Filtrar e ordenar agendamentos dos próximos 7 dias
            const upcoming = cache.bookings
                .filter(b => next7Days.includes(b.date) && new Date(`${b.date}T${b.time}`) >= now)
                .sort((a, b) => {
                    const dateA = new Date(`${a.date}T${a.time}`);
                    const dateB = new Date(`${b.date}T${b.time}`);
                    return dateA - dateB;
                });
            
            if (upcoming.length === 0) {
                container.innerHTML = `
                    <div class="empty-state py-8">
                        <i class="fa-regular fa-calendar-check text-slate-300"></i>
                        <h4 class="font-bold text-lg text-slate-700">Nenhum agendamento nos próximos dias</h4>
                        <p class="text-slate-500">Cadastre novos horários na aba de Agenda</p>
                    </div>
                `;
                return;
            }
            
            upcoming.forEach(booking => {
                const date = new Date(booking.date + 'T00:00:00');
                const client = cache.clients[booking.clientPhone] || { name: booking.clientName };
                const isToday = booking.date === new Date().toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' }).charAt(0).toUpperCase() + date.toLocaleDateString('pt-BR', { weekday: 'short' }).slice(1, 3);
                const dayNumber = date.getDate();
                
                const appointmentEl = document.createElement('div');
                appointmentEl.className = `flex items-center p-3 rounded-lg mb-2 border-l-4 ${isToday ? 'border-teal-500 bg-teal-50' : 'border-slate-300 bg-slate-50'}`;
                appointmentEl.innerHTML = `
                    <div class="mr-4 text-center min-w-[50px]">
                        <div class="font-bold text-slate-700">${dayName}</div>
                        <div class="text-lg font-bold text-slate-800">${dayNumber}</div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-slate-800 truncate" title="${client.name}">${client.name}</h4>
                                <div class="flex items-center mt-1 text-sm">
                                    <span class="bg-teal-100 text-teal-800 text-xs font-bold px-2 py-0.5 rounded mr-2">${booking.time}</span>
                                    <span class="text-xs text-slate-500">${booking.date.split('-').reverse().join('/')}</span>
                                </div>
                            </div>
                            <span class="text-sm font-bold text-green-600">R$ ${booking.value},00</span>
                        </div>
                    </div>
                    <div class="ml-3 flex flex-col items-end space-y-1">
                        <button onclick="openNotesModal('${booking.clientPhone}', '${client.name}')" class="w-8 h-8 bg-slate-200 text-slate-700 rounded-lg flex items-center justify-center hover:bg-slate-300 transition" title="Ver prontuário">
                            <i class="fa-solid fa-file-lines text-sm"></i>
                        </button>
                        <a href="https://wa.me/55${booking.clientPhone.replace(/\D/g,'')}" target="_blank" class="w-8 h-8 bg-green-100 text-green-700 rounded-lg flex items-center justify-center hover:bg-green-200 transition" title="WhatsApp">
                            <i class="fa-brands fa-whatsapp text-sm"></i>
                        </a>
                    </div>
                `;
                container.appendChild(appointmentEl);
            });
        }
        
        function loadRecentClients() {
            const container = document.getElementById('recent-clients');
            container.innerHTML = '';
            
            // Ordenar clientes pela última sessão
            const recentClients = Object.values(cache.clients)
                .filter(client => client.lastSession)
                .sort((a, b) => new Date(b.lastSession) - new Date(a.lastSession))
                .slice(0, 5);
            
            if (recentClients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state py-6">
                        <i class="fa-solid fa-users text-slate-300"></i>
                        <p class="text-slate-500">Nenhum paciente cadastrado ainda</p>
                    </div>
                `;
                return;
            }
            
            recentClients.forEach(client => {
                const lastSessionDate = new Date(client.lastSession + 'T00:00:00');
                const formattedDate = lastSessionDate.toLocaleDateString('pt-BR');
                const totalSessions = client.totalSessions || 1;
                
                const clientEl = document.createElement('div');
                clientEl.className = "flex items-center p-3 border-b border-slate-100 last:border-b-0";
                clientEl.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3 flex-shrink-0">
<span class="font-bold text-blue-700 text-sm">${client.name && client.name.length > 0 ? client.name.charAt(0) : '?'}</span>
</div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-slate-800 truncate" title="${client.name}">${client.name}</h4>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <span class="text-[11px] text-slate-500 flex items-center">
                                <i class="fa-solid fa-calendar-day mr-1 text-slate-400"></i> Última: ${formattedDate}
                            </span>
                            <span class="text-[11px] text-slate-500 flex items-center">
                                <i class="fa-solid fa-stethoscope mr-1 text-slate-400"></i> ${totalSessions} ${totalSessions !== 1 ? 'sessões' : 'sessão'}
                            </span>
                        </div>
                    </div>
                    <button onclick="openNotesModal('${client.phone}', '${client.name}')" class="w-8 h-8 bg-teal-50 text-teal-600 rounded-lg flex items-center justify-center hover:bg-teal-100 transition" title="Ver prontuário">
                        <i class="fa-solid fa-file-medical text-sm"></i>
                    </button>
                `;
                container.appendChild(clientEl);
            });
        }
        
        function openNextClientDetails() {
            const el = document.getElementById('dash-next-content');
            const phone = el.dataset.nextPhone;
            const name = el.dataset.nextName;
            
            if (phone && name) {
                openNotesModal(phone, name);
            } else {
                showToast("Nenhum agendamento encontrado para visualizar detalhes.", "error");
            }
        }
        
        let currentReminderBookingId = null;
        
        function openReminderModal(bookingId, clientName) {
            currentReminderBookingId = bookingId;
            document.getElementById('reminder-text').innerText = `Você está prestes a enviar um lembrete para ${clientName} sobre sua sessão.`;
            document.getElementById('modal-reminder').classList.remove('hidden');
        }
        
        async function sendReminderManually() {
            if (!currentReminderBookingId) return;
            
            try {
                showLoader(true);
                closeModal('modal-reminder');
                
                const booking = cache.bookings.find(b => b.id === currentReminderBookingId);
                if (!booking) {
                    throw new Error("Agendamento não encontrado");
                }
                
                const client = cache.clients[booking.clientPhone] || { name: booking.clientName };
                const clientFirstName = client.name.split(' ')[0];
                const formattedDate = booking.date.split('-').reverse().join('/');
                
                // Gerar mensagem de lembrete
                let message = (state.settings?.reminderMsg || "Olá {nome}, lembrando do nosso agendamento amanhã ({data}) às {hora}.")
                    .replace('{nome}', clientFirstName)
                    .replace('{data}', formattedDate)
                    .replace('{hora}', booking.time);
                
                if (state.settings?.videoLink) {
                    message += `\n\nLink para a sessão: ${state.settings.videoLink}`;
                }
                
                // Enviar para WhatsApp
                const whatsappUrl = `https://wa.me/55${booking.clientPhone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                // Atualizar status do lembrete no Firebase
                await db.collection('bookings').doc(booking.id).update({
                    reminderSent: true,
                    reminderSentAt: new Date()
                });
                
                // Atualizar cache
                const bookingIndex = cache.bookings.findIndex(b => b.id === booking.id);
                if (bookingIndex !== -1) {
                    cache.bookings[bookingIndex].reminderSent = true;
                    cache.bookings[bookingIndex].reminderSentAt = new Date();
                }
                
                showToast("Lembrete enviado com sucesso!");
            } catch (error) {
                console.error("Error sending reminder:", error);
                showToast("Erro ao enviar lembrete. Tente novamente.", "error");
            } finally {
                showLoader(false);
                currentReminderBookingId = null;
            }
        }
        
        async function renderClients() {
    const search = document.getElementById('client-search').value.toLowerCase();
    const list = document.getElementById('clients-list');
    list.innerHTML = '<div class="flex justify-center items-center py-10"><div class="text-center"><div class="loader mx-auto mb-3"></div><p class="text-slate-500">Carregando pacientes...</p></div></div>';
    
    try {
        let clients = Object.values(cache.clients);
        
        // Filtrar por pesquisa
        if (search) {
            clients = clients.filter(client => {
                const name = client.name || '';
                const phone = client.phone || '';
                const email = client.email || '';
                return name.toLowerCase().includes(search) ||
                       phone.toLowerCase().includes(search.replace(/\D/g, '')) ||
                       email.toLowerCase().includes(search);
            });
        }
        
        // Ordenar por última sessão (mais recente primeiro)
        clients.sort((a, b) => {
            if (!a.lastSession) return 1;
            if (!b.lastSession) return -1;
            return new Date(b.lastSession) - new Date(a.lastSession);
        });
        
        // Atualizar contador
        document.getElementById('clients-count').innerText = clients.length;
        
        // Mostrar/ocultar botão de carregar mais
        const loadMoreBtn = document.getElementById('load-more-clients');
        loadMoreBtn.classList.add('hidden');
        
        // Renderizar clientes
        if (clients.length === 0) {
            list.innerHTML = `
            <div class="empty-state py-10">
                <i class="fa-solid fa-magnifying-glass text-slate-300"></i>
                <h4 class="font-bold text-lg text-slate-700">Nenhum paciente encontrado</h4>
                <p class="text-slate-500">Tente outra busca ou cadastre um novo paciente</p>
                <button onclick="openNewClientModal()" class="mt-4 bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-teal-700 transition">
                    <i class="fa-solid fa-user-plus mr-1"></i> Cadastrar Novo Paciente
                </button>
            </div>
            `;
            return;
        }
        
        list.innerHTML = '';
        
        clients.slice(0, clientsPerPage).forEach(client => {
            // Validação segura dos dados do cliente
            const name = client.name || 'Paciente sem nome';
            const phone = client.phone || '';
            const email = client.email || null;
            const source = client.source || null;
            const lastSessionDate = client.lastSession ? new Date(client.lastSession + 'T00:00:00') : null;
            const formattedDate = lastSessionDate ? lastSessionDate.toLocaleDateString('pt-BR') : 'Nenhuma sessão';
            const totalSessions = client.totalSessions || 0;
            const createdAt = client.createdAt || new Date();
            
            // Escapar aspas simples para evitar quebrar o onclick
            const safeName = name.replace(/'/g, "\\'");
            const safePhone = phone.replace(/'/g, "\\'");
            
            const el = document.createElement('div');
            el.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100";
            el.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="min-w-0 flex-1">
                    <div class="flex items-start">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center mr-3 flex-shrink-0">
                            <span class="text-white text-lg font-bold">${name.charAt(0)}</span>
                        </div>
                        <div class="min-w-0 flex-1">
                            <h4 class="font-bold text-lg text-slate-800 truncate" title="${name}">${name}</h4>
                            <div class="flex flex-wrap items-center gap-2 mt-1">
                                <span class="text-sm text-slate-600 flex items-center">
                                    <i class="fa-solid fa-phone mr-1 text-slate-400"></i> ${phone}
                                </span>
                                ${email ? `
                                <span class="text-sm text-slate-600 flex items-center">
                                    <i class="fa-solid fa-envelope mr-1 text-slate-400"></i> ${email}
                                </span>` : ''}
                            </div>
                            <div class="flex flex-wrap items-center gap-2 mt-2 text-sm">
                                <span class="text-slate-500 flex items-center">
                                    <i class="fa-solid fa-calendar-day mr-1 text-slate-400"></i> Última sessão: ${formattedDate}
                                </span>
                                <span class="text-slate-500 flex items-center">
                                    <i class="fa-solid fa-user-injured mr-1 text-slate-400"></i> ${totalSessions} ${totalSessions !== 1 ? 'sessões' : 'sessão'}
                                </span>
                                ${source ? `
                                <span class="text-slate-500 flex items-center">
                                    <i class="fa-solid fa-bullhorn mr-1 text-slate-400"></i> Origem: ${source === 'indication' ? 'Indicação' : source === 'google' ? 'Google' : source === 'instagram' ? 'Instagram' : source === 'facebook' ? 'Facebook' : 'Outro'}
                                </span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col items-end space-y-2 ml-3">
                    <button onclick="openNotesModal('${safePhone}', '${safeName}')" class="w-9 h-9 bg-teal-50 text-teal-600 rounded-lg flex items-center justify-center hover:bg-teal-100 transition" title="Ver prontuário">
                        <i class="fa-solid fa-file-medical text-base"></i>
                    </button>
                    <a href="https://wa.me/55${phone.replace(/\D/g,'')}" target="_blank" class="w-9 h-9 bg-green-50 text-green-600 rounded-lg flex items-center justify-center hover:bg-green-100 transition" title="WhatsApp">
                        <i class="fa-brands fa-whatsapp text-base"></i>
                    </a>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
                <div class="text-sm">
                    <span class="text-xs text-slate-400 mr-2">Registrado em:</span>
                    <span class="font-medium text-slate-700">${new Date(createdAt?.toDate ? createdAt.toDate() : createdAt).toLocaleDateString('pt-BR')}</span>
                </div>
                <button onclick="openNewSessionModal('${safePhone}', '${safeName}')" class="text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-100 transition flex items-center">
                    <i class="fa-solid fa-calendar-plus mr-1"></i> Nova Sessão
                </button>
            </div>
            `;
            list.appendChild(el);
        });
        
        // Mostrar botão de carregar mais se houver mais clientes
        if (clients.length > clientsPerPage) {
            loadMoreBtn.classList.remove('hidden');
            loadMoreBtn.onclick = () => loadMoreClients(clients, clientsPerPage);
        }
        
    } catch (error) {
        console.error("Error rendering clients:", error);
        list.innerHTML = `
        <div class="empty-state py-10">
            <i class="fa-solid fa-triangle-exclamation text-red-300"></i>
            <h4 class="font-bold text-lg text-slate-700">Erro ao carregar pacientes</h4>
            <p class="text-slate-500">Tente atualizar a página ou verificar sua conexão</p>
            <button onclick="renderClients()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-600 transition">
                <i class="fa-solid fa-rotate mr-1"></i> Tentar Novamente
            </button>
        </div>
        `;
    }
}
        function loadMoreClients(clients, startIndex) {
    const list = document.getElementById('clients-list');
    const endIndex = Math.min(clients.length, startIndex + clientsPerPage);
    const moreClients = clients.slice(startIndex, endIndex);
    
    moreClients.forEach(client => {
        // Validação segura dos dados do cliente
        const name = client.name || 'Paciente sem nome';
        const phone = client.phone || '';
        const email = client.email || null;
        const source = client.source || null;
        const lastSessionDate = client.lastSession ? new Date(client.lastSession + 'T00:00:00') : null;
        const formattedDate = lastSessionDate ? lastSessionDate.toLocaleDateString('pt-BR') : 'Nenhuma sessão';
        const totalSessions = client.totalSessions || 0;
        const createdAt = client.createdAt || new Date();
        
        // Escapar aspas simples para evitar quebrar o onclick
        const safeName = name.replace(/'/g, "\\'");
        const safePhone = phone.replace(/'/g, "\\'");
        
        const el = document.createElement('div');
        el.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100";
        el.innerHTML = `
        <div class="flex justify-between items-start">
            <div class="min-w-0 flex-1">
                <div class="flex items-start">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center mr-3 flex-shrink-0">
                        <span class="text-white text-lg font-bold">${name.charAt(0)}</span>
                    </div>
                    <div class="min-w-0 flex-1">
                        <h4 class="font-bold text-lg text-slate-800 truncate" title="${name}">${name}</h4>
                        <div class="flex flex-wrap items-center gap-2 mt-1">
                            <span class="text-sm text-slate-600 flex items-center">
                                <i class="fa-solid fa-phone mr-1 text-slate-400"></i> ${phone}
                            </span>
                            ${email ? `
                            <span class="text-sm text-slate-600 flex items-center">
                                <i class="fa-solid fa-envelope mr-1 text-slate-400"></i> ${email}
                            </span>` : ''}
                        </div>
                        <div class="flex flex-wrap items-center gap-2 mt-2 text-sm">
                            <span class="text-slate-500 flex items-center">
                                <i class="fa-solid fa-calendar-day mr-1 text-slate-400"></i> Última sessão: ${formattedDate}
                            </span>
                            <span class="text-slate-500 flex items-center">
                                <i class="fa-solid fa-user-injured mr-1 text-slate-400"></i> ${totalSessions} ${totalSessions !== 1 ? 'sessões' : 'sessão'}
                            </span>
                            ${source ? `
                            <span class="text-slate-500 flex items-center">
                                <i class="fa-solid fa-bullhorn mr-1 text-slate-400"></i> Origem: ${source === 'indication' ? 'Indicação' : source === 'google' ? 'Google' : source === 'instagram' ? 'Instagram' : source === 'facebook' ? 'Facebook' : 'Outro'}
                            </span>` : ''}
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-end space-y-2 ml-3">
                <button onclick="openNotesModal('${safePhone}', '${safeName}')" class="w-9 h-9 bg-teal-50 text-teal-600 rounded-lg flex items-center justify-center hover:bg-teal-100 transition" title="Ver prontuário">
                    <i class="fa-solid fa-file-medical text-base"></i>
                </button>
                <a href="https://wa.me/55${phone.replace(/\D/g,'')}" target="_blank" class="w-9 h-9 bg-green-50 text-green-600 rounded-lg flex items-center justify-center hover:bg-green-100 transition" title="WhatsApp">
                    <i class="fa-brands fa-whatsapp text-base"></i>
                </a>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
            <div class="text-sm">
                <span class="text-xs text-slate-400 mr-2">Registrado em:</span>
                <span class="font-medium text-slate-700">${new Date(createdAt?.toDate ? createdAt.toDate() : createdAt).toLocaleDateString('pt-BR')}</span>
            </div>
            <button onclick="openNewSessionModal('${safePhone}', '${safeName}')" class="text-xs bg-blue-50 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-100 transition flex items-center">
                <i class="fa-solid fa-calendar-plus mr-1"></i> Nova Sessão
            </button>
        </div>
        `;
        list.appendChild(el);
    });
    
    const loadMoreBtn = document.getElementById('load-more-clients');
    if (endIndex < clients.length) {
        loadMoreBtn.classList.remove('hidden');
    } else {
        loadMoreBtn.classList.add('hidden');
    }
}
        
        async function openNewClientModal() {
            document.getElementById('modal-new-client').classList.remove('hidden');
            document.getElementById('client-name').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('client-birthdate').value = '';
            document.getElementById('client-reason').value = '';
            document.getElementById('client-medical-history').value = '';
        }
        
        async function saveNewClient(e) {
            e.preventDefault();
            const name = document.getElementById('client-name').value.trim();
            let phone = document.getElementById('client-phone').value.trim();
            const email = document.getElementById('client-email').value.trim();
            const birthdate = document.getElementById('client-birthdate').value;
            const reason = document.getElementById('client-reason').value.trim();
            const medicalHistory = document.getElementById('client-medical-history').value.trim();
            
            // Formatar o telefone para o padrão brasileiro
            phone = phone.replace(/\D/g, '');
            if (phone.length === 10) {
                phone = phone.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else if (phone.length === 11) {
                phone = phone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            
            if (!name || !phone) {
                showToast("Nome e WhatsApp são obrigatórios para cadastro.", "error");
                return;
            }
            
            if (!validatePhone(phone)) {
                showToast("Número de WhatsApp inválido. Use o formato (11) 99999-9999", "error");
                return;
            }
            
            showLoader(true);
            
            try {
                const formattedPhone = formatPhone(phone);
                
                // Verificar se cliente já existe
                if (cache.clients[formattedPhone]) {
                    showToast("Este paciente já está cadastrado no sistema.", "error");
                    return;
                }
                
                const clientData = {
                    name: name,
                    phone: formattedPhone,
                    email: email || null,
                    birthdate: birthdate || null,
                    reason: reason || null,
                    medicalHistory: medicalHistory || null,
                    source: 'manual',
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    lastSession: null,
                    totalSessions: 0
                };
                
                // Salvar no Firebase
                await db.collection('clients').doc(formattedPhone).set(clientData);
                
                // Adicionar ao cache
                cache.clients[formattedPhone] = clientData;
                
                // Fechar modal
                closeModal('modal-new-client');
                
                // Atualizar lista de clientes
                renderClients();
                updateDashboard();
                
                showToast("Novo paciente cadastrado com sucesso!");
            } catch (error) {
                console.error("Error saving new client:", error);
                showToast("Erro ao cadastrar novo paciente. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        function openNewSessionModal(phone, name) {
            // Redirecionar para a agenda na data atual
            navigateTo('view-admin');
            switchTab('calendar');
            
            // Selecionar a data de hoje no calendário
            const today = new Date().toISOString().split('T')[0];
            state.adminDate = new Date();
            renderAdminCalendar();
            
            // Abrir o modal do dia atual para agendar
            setTimeout(() => {
                openDayModal(today);
            }, 300);
            
            // Mostrar toast com informação
            showToast(`Pronto para agendar nova sessão para ${name}`);
        }
        
        async function renderFinancial() {
            showLoader(true);
            const container = document.getElementById('fin-history');
            const totalEl = document.getElementById('fin-total');
            const sessionsDoneEl = document.getElementById('fin-sessions-done');
            const cancellationRateEl = document.getElementById('fin-cancellation-rate');
            const averagePerSessionEl = document.getElementById('fin-average-per-session');
            const period = document.getElementById('financial-period').value;
            
            try {
                // Obter datas de referência
                const now = new Date();
                let startDate, endDate;
                
                switch (period) {
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                        break;
                    case 'quarter':
                        const quarterStartMonth = Math.floor(now.getMonth() / 3) * 3;
                        startDate = new Date(now.getFullYear(), quarterStartMonth, 1);
                        endDate = new Date(now.getFullYear(), quarterStartMonth + 3, 0);
                        break;
                    case 'semester':
                        const semesterStartMonth = Math.floor(now.getMonth() / 6) * 6;
                        startDate = new Date(now.getFullYear(), semesterStartMonth, 1);
                        endDate = new Date(now.getFullYear(), semesterStartMonth + 6, 0);
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        endDate = new Date(now.getFullYear(), 11, 31);
                        break;
                }
                
                // Formatar datas para consulta
                const startISO = startDate.toISOString().split('T')[0];
                const endISO = endDate.toISOString().split('T')[0];
                
                // Filtrar agendamentos no período
                const periodBookings = cache.bookings.filter(b => 
                    b.date >= startISO && b.date <= endISO && b.status === 'confirmed'
                );
                
                // Calcular métricas
                const totalRevenue = periodBookings.reduce((sum, b) => sum + (b.value || 0), 0);
                const sessionsDone = periodBookings.length;
                const cancellationRate = calculateCancellationRate(periodBookings, startISO, endISO);
                const averagePerSession = sessionsDone > 0 ? totalRevenue / sessionsDone : 0;
                
                // Atualizar UI
                totalEl.innerText = totalRevenue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                sessionsDoneEl.innerText = sessionsDone;
                cancellationRateEl.innerText = `${cancellationRate.toFixed(1)}%`;
                averagePerSessionEl.innerText = averagePerSession.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                
                // Agrupar receita por mês
                const monthsMap = {};
                
                periodBookings.forEach(booking => {
                    const monthKey = booking.date.substring(0, 7); // YYYY-MM
                    
                    if (!monthsMap[monthKey]) {
                        monthsMap[monthKey] = {
                            total: 0,
                            count: 0
                        };
                    }
                    
                    monthsMap[monthKey].total += booking.value || 150;
                    monthsMap[monthKey].count += 1;
                });
                
                // Renderizar histórico
                container.innerHTML = '';
                
                if (Object.keys(monthsMap).length === 0) {
                    container.innerHTML = `
                        <div class="p-4 text-center text-slate-500">
                            <i class="fa-regular fa-calendar-xmark text-3xl opacity-50 mb-2 block"></i>
                            <p>Nenhum agendamento no período selecionado</p>
                        </div>
                    `;
                    return;
                }
                
                // Ordenar por mês (mais recente primeiro)
                const sortedMonths = Object.keys(monthsMap).sort().reverse();
                
                sortedMonths.forEach(monthKey => {
                    const data = monthsMap[monthKey];
                    const [year, month] = monthKey.split('-');
                    const monthDate = new Date(parseInt(year), parseInt(month) - 1);
                    const monthName = monthDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                    
                    const row = document.createElement('div');
                    row.className = "p-4 hover:bg-slate-50 transition border-b border-slate-100 last:border-b-0";
                    row.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-slate-800 capitalize">${monthName}</span>
                            <span class="font-bold text-slate-800">${data.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                        </div>
                        <div class="flex justify-between text-xs text-slate-500">
                            <span>${data.count} sessão${data.count !== 1 ? 'es' : ''}</span>
                            <span>Média: ${Math.round(data.total / data.count).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                        </div>
                        <div class="mt-3 h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-teal-500 rounded-full" style="width: ${Math.min(100, (data.total / (Math.max(...Object.values(monthsMap).map(m => m.total)) || 1)) * 100)}%"></div>
                        </div>
                    `;
                    container.appendChild(row);
                });
                
            } catch (error) {
                console.error("Error rendering financial data:", error);
                container.innerHTML = `
                    <div class="p-4 text-center text-red-500">
                        <i class="fa-solid fa-triangle-exclamation text-2xl mb-2 block"></i>
                        <p>Erro ao carregar dados financeiros</p>
                    </div>
                `;
            } finally {
                showLoader(false);
            }
        }
        
        function calculateCancellationRate(bookings, startDate, endDate) {
            // Implementação simples - na versão completa, isso viria do Firebase
            const totalPossible = 30; // Número estimado de dias úteis no período
            const cancellations = 0; // Dados de cancelamentos viriam do Firebase
            return totalPossible > 0 ? (cancellations / totalPossible) * 100 : 0;
        }
        
        async function exportClientsToCSV() {
            showLoader(true);
            try {
                const clients = Object.values(cache.clients);
                
                if (clients.length === 0) {
                    showToast("Nenhum paciente para exportar.", "error");
                    return;
                }
                
                // Cabeçalhos do CSV
                const headers = [
                    'Nome',
                    'Telefone',
                    'Email',
                    'Data de Nascimento',
                    'Motivo da Consulta',
                    'Histórico Médico',
                    'Origem',
                    'Data de Registro',
                    'Última Sessão',
                    'Total de Sessões'
                ];
                
                // Dados
                const rows = clients.map(client => [
                    client.name || '',
                    client.phone || '',
                    client.email || '',
                    client.birthdate ? new Date(client.birthdate.toDate()).toLocaleDateString('pt-BR') : '',
                    client.reason || '',
                    client.medicalHistory || '',
                    client.source || '',
                    new Date(client.createdAt?.toDate() || client.createdAt).toLocaleDateString('pt-BR'),
                    client.lastSession ? new Date(client.lastSession + 'T00:00:00').toLocaleDateString('pt-BR') : '',
                    client.totalSessions || 0
                ]);
                
                // Montar CSV
                let csvContent = "text/csv;charset=utf-8,";
                csvContent += headers.join(';') + '\n';
                
                rows.forEach(row => {
                    csvContent += row.map(field => 
                        typeof field === 'string' ? `"${field.replace(/"/g, '""')}"` : field
                    ).join(';') + '\n';
                });
                
                // Download
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `pacientes_psipro_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast("Pacientes exportados com sucesso!");
            } catch (error) {
                console.error("Error exporting clients:", error);
                showToast("Erro ao exportar pacientes. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        function generateReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const reportType = document.getElementById('report-type').value;
            
            if (!startDate || !endDate) {
                showToast("Selecione um período válido para o relatório.", "error");
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showToast("A data inicial não pode ser posterior à data final.", "error");
                return;
            }
            
            showLoader(true);
            const resultsContainer = document.getElementById('report-results');
            resultsContainer.querySelector('.empty-state').style.display = 'none';
            
            setTimeout(() => {
                try {
                    let reportHTML = '';
                    const periodText = `${new Date(startDate).toLocaleDateString('pt-BR')} a ${new Date(endDate).toLocaleDateString('pt-BR')}`;
                    
                    switch (reportType) {
                        case 'attendance':
                            reportHTML = generateAttendanceReport(startDate, endDate, periodText);
                            break;
                        case 'revenue':
                            reportHTML = generateRevenueReport(startDate, endDate, periodText);
                            break;
                        case 'clients':
                            reportHTML = generateClientsReport(startDate, endDate, periodText);
                            break;
                        case 'cancellations':
                            reportHTML = generateCancellationsReport(startDate, endDate, periodText);
                            break;
                    }
                    
                    resultsContainer.innerHTML = reportHTML;
                    showToast("Relatório gerado com sucesso!");
                } catch (error) {
                    console.error("Error generating report:", error);
                    resultsContainer.innerHTML = `
                        <div class="p-6 text-center text-red-500">
                            <i class="fa-solid fa-triangle-exclamation text-3xl mb-2 block"></i>
                            <p>Erro ao gerar relatório. Tente novamente.</p>
                        </div>
                    `;
                } finally {
                    showLoader(false);
                }
            }, 500);
        }
        
        function generateAttendanceReport(startDate, endDate, periodText) {
            // Filtrar agendamentos no período
            const periodBookings = cache.bookings.filter(b => 
                b.date >= startDate && b.date <= endDate && b.status === 'confirmed'
            );
            
            // Agrupar por dia da semana
            const weekdays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            const weekdayCounts = Array(7).fill(0);
            const hourlyCounts = {};
            
            // Contar agendamentos por dia da semana e hora
            periodBookings.forEach(booking => {
                const date = new Date(booking.date + 'T00:00:00');
                const dayIndex = date.getDay();
                weekdayCounts[dayIndex]++;
                
                const hour = booking.time.split(':')[0];
                if (!hourlyCounts[hour]) hourlyCounts[hour] = 0;
                hourlyCounts[hour]++;
            });
            
            // Montar relatório
            return `
                <div class="p-5">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Relatório de Atendimentos</h3>
                    <p class="text-sm text-slate-500 mb-6">Período: ${periodText} | Total de Sessões: ${periodBookings.length}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h4 class="font-bold text-slate-700 mb-3">Sessões por Dia da Semana</h4>
                            <div class="space-y-3">
                                ${weekdays.map((day, i) => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-slate-700">${day}</span>
                                        <div class="flex items-center">
                                            <span class="text-sm font-bold text-slate-800 mr-3">${weekdayCounts[i]}</span>
                                            <div class="w-16 bg-slate-200 rounded-full h-2 overflow-hidden">
                                                <div class="h-full bg-teal-500 rounded-full" style="width: ${Math.min(100, weekdayCounts[i] / Math.max(...weekdayCounts) * 100)}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h4 class="font-bold text-slate-700 mb-3">Sessões por Horário</h4>
                            <div class="space-y-2 max-h-48 overflow-y-auto pr-2">
                                ${Object.entries(hourlyCounts).sort().map(([hour, count]) => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-slate-700">${hour}h</span>
                                        <div class="flex items-center">
                                            <span class="text-sm font-bold text-slate-800 mr-3">${count}</span>
                                            <div class="w-16 bg-slate-200 rounded-full h-2 overflow-hidden">
                                                <div class="h-full bg-amber-400 rounded-full" style="width: ${Math.min(100, count / Math.max(...Object.values(hourlyCounts)) * 100)}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200" id="attendance-report">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Data</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Horário</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Paciente</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Valor</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-100">
                                ${periodBookings.sort((a, b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time)).map(booking => {
                                    const client = cache.clients[booking.clientPhone] || { name: booking.clientName };
                                    return `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${booking.date.split('-').reverse().join('/')}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-800">${booking.time}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-800">${client.name}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 font-medium">R$ ${booking.value},00</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                        <button onclick="exportTableToCSV('attendance-report', 'relatorio_atendimentos')" class="text-sm bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition">
                            <i class="fa-solid fa-file-csv mr-1"></i> Exportar CSV
                        </button>
                    </div>
                </div>
            `;
        }
        
        function generateRevenueReport(startDate, endDate, periodText) {
            // Filtrar agendamentos no período
            const periodBookings = cache.bookings.filter(b => 
                b.date >= startDate && b.date <= endDate && b.status === 'confirmed'
            );
            
            // Calcular totais
            const totalRevenue = periodBookings.reduce((sum, b) => sum + (b.value || 0), 0);
            const averagePerSession = periodBookings.length > 0 ? totalRevenue / periodBookings.length : 0;
            
            // Agrupar por semana
            const weeksMap = {};
            periodBookings.forEach(booking => {
                const date = new Date(booking.date + 'T00:00:00');
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay()); // Domingo como início da semana
                const weekKey = weekStart.toISOString().split('T')[0];
                
                if (!weeksMap[weekKey]) {
                    weeksMap[weekKey] = { total: 0, count: 0 };
                }
                
                weeksMap[weekKey].total += booking.value || 0;
                weeksMap[weekKey].count += 1;
            });
            
            return `
                <div class="p-5">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Relatório Financeiro</h3>
                    <p class="text-sm text-slate-500 mb-6">Período: ${periodText}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-4">
                            <p class="text-xs font-bold uppercase tracking-wider opacity-90">Receita Total</p>
                            <p class="text-2xl font-bold mt-1">${totalRevenue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-4">
                            <p class="text-xs font-bold uppercase tracking-wider opacity-90">Número de Sessões</p>
                            <p class="text-2xl font-bold mt-1">${periodBookings.length}</p>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-amber-600 text-white rounded-xl p-4">
                            <p class="text-xs font-bold uppercase tracking-wider opacity-90">Média por Sessão</p>
                            <p class="text-2xl font-bold mt-1">${averagePerSession.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden mb-6">
                        <div class="p-4 border-b border-slate-100">
                            <h4 class="font-bold text-slate-700">Receita por Semana</h4>
                        </div>
                        <div class="p-4">
                            <div class="h-48 flex items-end justify-around mb-4">
                                ${Object.entries(weeksMap).sort().map(([weekKey, data]) => {
                                    const date = new Date(weekKey + 'T00:00:00');
                                    const weekNumber = getWeekNumber(date);
                                    const percentage = Math.min(100, data.total / Math.max(...Object.values(weeksMap).map(w => w.total)) * 100);
                                    
                                    return `
                                        <div class="text-center">
                                            <div class="bg-green-400 w-6 mx-auto rounded-t-lg" style="height: ${Math.max(20, percentage)}px;"></div>
                                            <span class="text-[10px] mt-1 block text-slate-500">Semana ${weekNumber}</span>
                                            <span class="text-[10px] font-bold text-slate-700 mt-1">${data.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200" id="attendance-report">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Data</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Paciente</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Valor</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Pago</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-100">
                                ${periodBookings.sort((a, b) => a.date.localeCompare(b.date)).map(booking => {
                                    const client = cache.clients[booking.clientPhone] || { name: booking.clientName };
                                    return `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${booking.date.split('-').reverse().join('/')}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-800">${client.name}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 font-medium">R$ ${booking.value},00</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Sim</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                                ${periodBookings.length === 0 ? `
                                    <tr>
                                        <td colspan="4" class="px-4 py-8 text-center text-slate-500">
                                            Nenhum agendamento confirmado no período selecionado
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                            <tfoot class="bg-slate-50">
                                <tr>
                                    <td colspan="2" class="px-4 py-3 text-sm font-bold text-right">TOTAL:</td>
                                    <td class="px-4 py-3 text-sm font-bold text-green-700">R$ ${totalRevenue},00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                        <button onclick="exportTableToCSV('attendance-report', 'relatorio_financeiro')" class="text-sm bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition">
                            <i class="fa-solid fa-file-csv mr-1"></i> Exportar CSV
                        </button>
                    </div>
                </div>
            `;
        }
        
        function generateClientsReport(startDate, endDate, periodText) {
            // Filtrar pacientes que tiveram sessões no período
            const periodBookings = cache.bookings.filter(b => 
                b.date >= startDate && b.date <= endDate && b.status === 'confirmed'
            );
            
            // Agrupar por paciente
            const clientsMap = {};
            periodBookings.forEach(booking => {
                const clientPhone = booking.clientPhone;
                if (!clientsMap[clientPhone]) {
                    clientsMap[clientPhone] = {
                        sessions: [],
                        totalValue: 0,
                        client: cache.clients[clientPhone] || { name: booking.clientName }
                    };
                }
                
                clientsMap[clientPhone].sessions.push({
                    date: booking.date,
                    time: booking.time,
                    value: booking.value || 150
                });
                
                clientsMap[clientPhone].totalValue += booking.value || 150;
            });
            
            // Converter para array e ordenar por quantidade de sessões
            const clientsArray = Object.values(clientsMap)
                .map((data, index) => ({
                    phone: Object.keys(clientsMap)[index],
                    ...data
                }))
                .sort((a, b) => b.sessions.length - a.sessions.length);
            
            return `
                <div class="p-5">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Relatório de Pacientes Atendidos</h3>
                    <p class="text-sm text-slate-500 mb-6">Período: ${periodText} | Total de Pacientes: ${clientsArray.length}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h4 class="font-bold text-slate-700 mb-3">Top 5 Pacientes por Frequência</h4>
                            <div class="space-y-3">
                                ${clientsArray.slice(0, 5).map((clientData, i) => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-slate-700">${i+1}. ${clientData.client.name}</span>
                                        <div class="flex items-center">
                                            <span class="text-sm font-bold text-slate-800 mr-3">${clientData.sessions.length} sessões</span>
                                            <div class="w-16 bg-slate-200 rounded-full h-2 overflow-hidden">
                                                <div class="h-full bg-blue-500 rounded-full" style="width: ${Math.min(100, clientData.sessions.length / Math.max(...clientsArray.map(c => c.sessions.length)) * 100)}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 rounded-xl p-4">
                            <h4 class="font-bold text-slate-700 mb-3">Top 5 Pacientes por Receita</h4>
                            <div class="space-y-3">
                                ${clientsArray.slice(0, 5).sort((a, b) => b.totalValue - a.totalValue).map((clientData, i) => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-slate-700">${i+1}. ${clientData.client.name}</span>
                                        <div class="flex items-center">
                                            <span class="text-sm font-bold text-green-600 mr-3">${clientData.totalValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                            <div class="w-16 bg-slate-200 rounded-full h-2 overflow-hidden">
                                                <div class="h-full bg-green-500 rounded-full" style="width: ${Math.min(100, clientData.totalValue / Math.max(...clientsArray.map(c => c.totalValue)) * 100)}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200" id="attendance-report">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Paciente</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Sessões</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Valor Total</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Média por Sessão</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Primeira Sessão</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Última Sessão</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-100">
                                ${clientsArray.map(clientData => {
                                    const sessions = clientData.sessions;
                                    const firstSession = sessions.sort((a, b) => a.date.localeCompare(b.date))[0];
                                    const lastSession = sessions[sessions.length - 1];
                                    
                                    return `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-800">${clientData.client.name}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${clientData.sessions.length}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 font-medium">${clientData.totalValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-amber-600 font-medium">${(clientData.totalValue / clientData.sessions.length).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${firstSession.date.split('-').reverse().join('/')}</td>
                                            <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-600">${lastSession.date.split('-').reverse().join('/')}</td>
                                        </tr>
                                    `;
                                }).join('')}
                                ${clientsArray.length === 0 ? `
                                    <tr>
                                        <td colspan="6" class="px-4 py-8 text-center text-slate-500">
                                            Nenhum paciente atendido no período selecionado
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-slate-100 flex justify-end">
                        <button onclick="exportTableToCSV('attendance-report', 'relatorio_pacientes')" class="text-sm bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition">
                            <i class="fa-solid fa-file-csv mr-1"></i> Exportar CSV
                        </button>
                    </div>
                </div>
            `;
        }
        
        function generateCancellationsReport(startDate, endDate, periodText) {
            return `
                <div class="p-5">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Relatório de Cancelamentos</h3>
                    <p class="text-sm text-slate-500 mb-6">Período: ${periodText}</p>
                    
                    <div class="bg-slate-50 rounded-xl p-6 text-center mb-6">
                        <i class="fa-solid fa-ban text-4xl text-red-400 mb-3"></i>
                        <h4 class="text-lg font-bold text-slate-700 mb-2">Funcionalidade em Desenvolvimento</h4>
                        <p class="text-slate-600">A funcionalidade completa de relatório de cancelamentos estará disponível em próximas versões do sistema.</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl p-4">
                            <p class="text-xs font-bold uppercase tracking-wider opacity-90">Cancelamentos</p>
                            <p class="text-2xl font-bold mt-1">0</p>
                            <p class="text-xs opacity-80 mt-1">Período selecionado</p>
                        </div>
                        <div class="bg-gradient-to-br from-pink-500 to-pink-600 text-white rounded-xl p-4">
                            <p class="text-xs font-bold uppercase tracking-wider opacity-90">Taxa de Cancelamento</p>
                            <p class="text-2xl font-bold mt-1">0%</p>
                            <p class="text-xs opacity-80 mt-1">Em relação ao total</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-4">
                            <p class="text-xs font-bold uppercase tracking-wider opacity-90">Impacto Financeiro</p>
                            <p class="text-2xl font-bold mt-1">R$ 0,00</p>
                            <p class="text-xs opacity-80 mt-1">Valor estimado perdido</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-5 border-b border-slate-100">
                            <h4 class="font-bold text-slate-800">Motivos de Cancelamento (Exemplo)</h4>
                        </div>
                        <div class="p-4">
                            <ul class="space-y-2 text-slate-600">
                                <li class="flex items-start">
                                    <span class="w-2 h-2 bg-red-500 rounded-full mt-2 mr-2"></span>
                                    <span>Doença ou problema de saúde - 0 casos (0%)</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="w-2 h-2 bg-red-500 rounded-full mt-2 mr-2"></span>
                                    <span>Falta de tempo ou compromisso inadiável - 0 casos (0%)</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="w-2 h-2 bg-red-500 rounded-full mt-2 mr-2"></span>
                                    <span>Desistência do tratamento - 0 casos (0%)</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="w-2 h-2 bg-red-500 rounded-full mt-2 mr-2"></span>
                                    <span>Outros motivos - 0 casos (0%)</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-6 bg-blue-50 p-4 rounded-xl">
                        <p class="text-sm text-blue-700 flex items-start">
                            <i class="fa-solid fa-circle-info mt-1 mr-2"></i> 
                            <strong>Nota:</strong> Para utilizar o relatório completo de cancelamentos, é necessário registrar os cancelamentos no sistema. Esta funcionalidade será implementada em atualizações futuras.
                        </p>
                    </div>
                </div>
            `;
        }
        
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
        
        async function saveSettings() {
            showLoader(true);
            const saveButton = document.querySelector('#tab-settings button');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fa-solid fa-spinner animate-spin mr-1"></i> Salvando...';
            
            try {
                // Obter valores dos campos
                const professionalName = document.getElementById('setting-professional-name').value.trim();
                const crp = document.getElementById('setting-crp').value.trim();
                const specialties = document.getElementById('setting-specialties').value.trim();
                const sessionValue = parseFloat(document.getElementById('setting-session-value').value) || 150;
                const sessionDuration = parseInt(document.getElementById('setting-session-duration').value) || 50;
                const confirmMsg = document.getElementById('setting-msg-confirm').value.trim();
                const reminderMsg = document.getElementById('setting-msg-reminder').value.trim();
                const videoLink = document.getElementById('setting-video-link').value.trim();
                
                // Obter dias úteis selecionados
                const workingDays = [];
                document.querySelectorAll('#tab-settings input[type="checkbox"]').forEach(checkbox => {
                    if (checkbox.checked) {
                        workingDays.push(checkbox.id.replace('day-', ''));
                    }
                });
                
                // Validar dados obrigatórios
                if (!professionalName || !crp) {
                    showToast("Nome do profissional e registro (CRP) são obrigatórios.", "error");
                    return;
                }
                
                // Atualizar state.settings
                state.settings = {
                    ...state.settings,
                    professionalName,
                    crp,
                    specialties,
                    sessionValue,
                    sessionDuration,
                    confirmMsg,
                    reminderMsg,
                    videoLink,
                    workingDays,
                    updatedAt: new Date()
                };
                
                // Salvar no Firebase
                await db.collection('settings').doc('main').set(state.settings, { merge: true });
                
                // Atualizar informações do profissional na view do cliente SOMENTE se os elementos existirem
const profileTitle = document.querySelector('#view-profile h1');
const profileSubtitle = document.querySelector('#view-profile .text-blue-600');
const sessionValueElement = document.querySelector('#view-profile .text-lg.font-bold.text-blue-700');
const confirmBarValue = document.querySelector('#client-confirm-bar .text-sm.font-bold.text-blue-600');

if (profileTitle) profileTitle.innerText = professionalName;
if (profileSubtitle) profileSubtitle.innerHTML = `${professionalName.split(' ')[0]} &bull; ${crp}`;
if (sessionValueElement) sessionValueElement.innerText = `R$ ${sessionValue}`;
if (confirmBarValue) confirmBarValue.innerText = `R$ ${sessionValue},00`;

// Atualizar especialidades SOMENTE se o container existir
const specialtiesContainer = document.querySelector('#view-profile .flex.flex-wrap.gap-2');
if (specialtiesContainer) {
specialtiesContainer.innerHTML = '';
specialties.split(',').map(s => s.trim()).forEach(specialty => {
if (specialty) {
specialtiesContainer.innerHTML += `
<span class="px-3 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">${specialty}</span>
`;
}
});
}
                
                showToast("Configurações salvas com sucesso!");
            } catch (error) {
                console.error("Error saving settings:", error);
                showToast("Erro ao salvar configurações. Tente novamente.", "error");
            } finally {
                showLoader(false);
                saveButton.innerHTML = originalText;
            }
        }
        
        async function exportAllData() {
            if (!confirm("Você está prestes a exportar TODOS os dados do sistema. Deseja continuar?")) {
                return;
            }
            
            showLoader(true);
            
            try {
                // Coletar todos os dados
                const exportData = {
                    timestamp: new Date().toISOString(),
                    settings: state.settings,
                    slots: cache.slots,
                    bookings: cache.bookings,
                    clients: Object.values(cache.clients),
                    notes: await getAllNotes()
                };
                
                // Converter para JSON e fazer download
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `psipro_backup_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showToast("Backup completo exportado com sucesso!");
            } catch (error) {
                console.error("Error exporting ", error);
                showToast("Erro ao exportar dados. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        async function getAllNotes() {
            const notesSnapshot = await db.collection('notes').get();
            const notes = {};
                
            notesSnapshot.forEach(doc => {
                notes[doc.id] = doc.data();
            });
                
            return notes;
        }
        
        async function importData() {
            showLoader(true);
                
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                    
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                        
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const jsonData = JSON.parse(event.target.result);
                                
                            if (!confirm("Isso substituirá todos os dados atuais do sistema. Deseja continuar?")) {
                                return;
                            }
                                
                            showLoader(true);
                                
                            // Importar configurações
                            if (jsonData.settings) {
                                await db.collection('settings').doc('main').set(jsonData.settings);
                                state.settings = jsonData.settings;
                            }
                                
                            // Importar slots
                            if (jsonData.slots) {
                                for (const [date, slotData] of Object.entries(jsonData.slots)) {
                                    await db.collection('slots').doc(date).set({
                                        times: slotData.times || slotData,
                                        date: date,
                                        updatedAt: new Date()
                                    });
                                }
                            }
                                
                            // Importar clientes
                            if (jsonData.clients) {
                                for (const client of jsonData.clients) {
                                    await db.collection('clients').doc(client.phone).set(client);
                                }
                            }
                                
                            // Importar agendamentos
                            if (jsonData.bookings) {
                                for (const booking of jsonData.bookings) {
                                    await db.collection('bookings').doc(booking.id).set(booking);
                                }
                            }
                                
                            // Importar notas
                            if (jsonData.notes) {
                                for (const [phone, note] of Object.entries(jsonData.notes)) {
                                    await db.collection('notes').doc(phone).set(note);
                                }
                            }
                                
                            // Recarregar dados
                            await Promise.all([
                                loadSettings(),
                                loadSlotsCache(),
                                loadBookingsCache(),
                                loadClientsCache()
                            ]);
                                
                            // Atualizar interface
                            if (state.view === 'view-admin') {
                                renderAdminCalendar();
                                updateDashboard();
                            } else {
                                renderClientDates();
                                renderClientSlots();
                            }
                                
                            showToast("Dados importados com sucesso! O sistema foi atualizado.");
                        } catch (error) {
                            console.error("Error processing import file:", error);
                            showToast("Erro ao processar arquivo de backup. Verifique se o arquivo está no formato correto.", "error");
                        } finally {
                            showLoader(false);
                        }
                    };
                    reader.readAsText(file);
                };
                    
                input.click();
            } catch (error) {
                console.error("Error importing ", error);
                showToast("Erro ao importar dados. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        async function resetApp() {
            if (!confirm("ATENÇÃO: Isso apagará TODOS os dados do sistema, incluindo agendamentos, pacientes e configurações. Esta ação não pode ser desfeita. Deseja continuar?")) {
                return;
            }
            
            showLoader(true);
            
            try {
                // Resetar dados no Firebase
                const batch = db.batch();
                
                // Remover todos os documentos das coleções
                const collections = ['slots', 'bookings', 'clients', 'notes'];
                
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).get();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                }
                
                // Resetar configurações para padrão
                const defaultSettings = {
                    confirmMsg: "Olá {nome}, confirmo seu agendamento para o dia {data} às {hora}.",
                    reminderMsg: "Olá {nome}, lembrando do nosso agendamento amanhã ({data}) às {hora}.",
                    videoLink: "https://meet.google.com/psipro-consulta",
                    professionalName: "Vinicius Ravagnani",
                    crp: "CRP 06/12345",
                    specialties: "Terapia Cognitivo-Comportamental, Ansiedade, Autoconhecimento",
                    sessionValue: 150,
                    sessionDuration: 50,
                    workingDays: ["mon", "tue", "wed", "thu", "fri"],
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                batch.set(db.collection('settings').doc('main'), defaultSettings);
                
                // Executar batch
                await batch.commit();
                
                // Resetar cache local
                cache = {
                    slots: {},
                    bookings: [],
                    clients: {},
                    notes: {},
                    lastUpdated: new Date()
                };
                
                // Recarregar dados
                await Promise.all([
                    loadSettings(),
                    loadSlotsCache(),
                    loadBookingsCache(),
                    loadClientsCache()
                ]);
                
                // Atualizar interface
                if (state.view === 'view-admin') {
                    renderAdminCalendar();
                    updateDashboard();
                } else {
                    renderClientDates();
                    renderClientSlots();
                }
                
                showToast("Sistema resetado com sucesso! Todos os dados foram apagados.", "success");
            } catch (error) {
                console.error("Error resetting app:", error);
                showToast("Erro ao resetar o sistema. Tente novamente.", "error");
            } finally {
                showLoader(false);
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // Fechar modais ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.add('hidden');
                }
            });
        });
        
        // Função para exportar tabela para CSV
        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId) || document.querySelector(`#${tableId}`);
            if (!table) return;
        
            let csv = [];
            const rows = table.querySelectorAll('tr');
                
            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');
                    
                for (let j = 0; j < cols.length; j++) {
                    // Remover tags HTML e pegar apenas o texto
                    let data = cols[j].innerText.replace(/,/g, ';').replace(/\n/g, ' ');
                    row.push(`"${data}"`);
                }
                    
                csv.push(row.join(';'));
            }
                
            // Download
            const csvFile = new Blob([csv.join('\n')], {type: 'text/csv'});
            const downloadLink = document.createElement('a');
            downloadLink.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
        
        // Helper function to format date
        function formatDate(date) {
            if (!date) return '';
            return new Date(date.toDate ? date.toDate() : date).toLocaleDateString('pt-BR');
        }
        
        // Helper function to format time
        function formatTime(timeString) {
            if (!timeString) return '';
            return timeString.substring(0, 5);
        }
        
        // Add event listeners for real-time updates
        function setupRealtimeListeners() {
            // Slots collection
            db.collection('slots').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const data = change.doc.data();
                        cache.slots[change.doc.id] = data.times || [];
                    } else if (change.type === 'removed') {
                        delete cache.slots[change.doc.id];
                    }
                });
                console.log("Slots cache updated in real-time");
            });
        
            // Bookings collection
            db.collection('bookings').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    const booking = change.doc.data();
                    booking.id = change.doc.id;
                    
                    if (change.type === 'added') {
                        cache.bookings.unshift(booking);
                    } else if (change.type === 'modified') {
                        const index = cache.bookings.findIndex(b => b.id === booking.id);
                        if (index !== -1) {
                            cache.bookings[index] = booking;
                        }
                    } else if (change.type === 'removed') {
                        cache.bookings = cache.bookings.filter(b => b.id !== booking.id);
                    }
                });
                
                // Keep only the 100 most recent bookings
                cache.bookings.sort((a, b) => new Date(b.createdAt?.toDate() || b.createdAt) - new Date(a.createdAt?.toDate() || a.createdAt));
                if (cache.bookings.length > 100) {
                    cache.bookings = cache.bookings.slice(0, 100);
                }
                
                console.log("Bookings cache updated in real-time");
            });
        
            // Clients collection
            db.collection('clients').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    const client = change.doc.data();
                    client.id = change.doc.id;
                    
                    if (change.type === 'added' || change.type === 'modified') {
                        cache.clients[client.phone || change.doc.id] = client;
                    } else if (change.type === 'removed') {
                        delete cache.clients[client.phone || change.doc.id];
                    }
                });
                console.log("Clients cache updated in real-time");
            });
        }
        
        // Initialize real-time listeners
        setupRealtimeListeners();
        
        // Touch events for mobile compatibility
        document.addEventListener('touchstart', handleTouchStart, false);
        document.addEventListener('touchmove', handleTouchMove, false);
        
        let xDown = null;
        let yDown = null;
        
        function handleTouchStart(evt) {
            xDown = evt.touches[0].clientX;
            yDown = evt.touches[0].clientY;
        }
        
        function handleTouchMove(evt) {
            if (!xDown || !yDown) {
                return;
            }
        
            const xUp = evt.touches[0].clientX;
            const yUp = evt.touches[0].clientY;
        
            const xDiff = xDown - xUp;
            const yDiff = yDown - yUp;
        
            // Swipe down to close modals
            if (Math.abs(xDiff) < Math.abs(yDiff) && yDiff < -50) {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.classList.add('hidden');
                });
            }
        
            // Reset values
            xDown = null;
            yDown = null;
        }
        function sendQuickMsg() {
  const el = document.getElementById('dash-next-content');
  const phone = el.dataset.nextPhone;
  
  if (!phone) {
    showToast("Nenhum agendamento encontrado para enviar mensagem.", "error");
    return;
  }
  
  // Armazenar dados do próximo agendamento no state
  state.nextAppointment = {
    phone: phone,
    time: document.getElementById('dash-next-time').innerText,
    date: document.getElementById('dash-next-badge').innerText === 'HOJE' ? 
          new Date().toLocaleDateString('pt-BR') : 
          document.getElementById('dash-next-badge').innerText,
    name: el.dataset.nextName,
    bookingId: el.dataset.nextId
  };
  
  // Abrir o modal de seleção de mensagem
  document.getElementById('modal-message-selection').classList.remove('hidden');
}

        function sendMessage(messageType) {
  closeModal('modal-message-selection'); // Fechar o modal
  
  if (!state.nextAppointment) {
    showToast("Dados do agendamento não disponíveis.", "error");
    return;
  }
  
  const { phone, time, date, name, bookingId } = state.nextAppointment;
  const clientFirstName = name.split(' ')[0];
  const booking = cache.bookings.find(b => b.id === bookingId);
  const value = booking?.value || (state.settings?.sessionValue || 150);
  const appointmentDate = booking?.date || new Date().toISOString().split('T')[0];
  
  let message = '';
  
  if (messageType === 'confirm') {
    // Usar o template de confirmação das configurações
    message = (state.settings?.confirmMsg || "Olá {nome}, confirmo seu agendamento para o dia {data} às {hora}. Valor: R$ {valor}.")
      .replace('{nome}', clientFirstName)
      .replace('{data}', date)
      .replace('{hora}', time)
      .replace('{valor}', value);
      
    showToast("Mensagem de confirmação preparada para envio!");
  } 
  else if (messageType === 'reminder') {
    // Para lembrete, usar data do agendamento formatada
    const formattedDate = appointmentDate.split('-').reverse().join('/');
    
    message = (state.settings?.reminderMsg || "Olá {nome}, lembrando do nosso agendamento amanhã ({data}) às {hora}.")
      .replace('{nome}', clientFirstName)
      .replace('{data}', formattedDate)
      .replace('{hora}', time);
      
    showToast("Mensagem de lembrete preparada para envio!");
    
    // Atualizar status do lembrete no Firebase
    updateReminderStatus(bookingId);
  }
  
  // Adicionar link de videochamada se existir
  if (state.settings?.videoLink) {
    message += `\n\nLink para a sessão: ${state.settings.videoLink}`;
  }
  
  // Abrir WhatsApp com a mensagem
  const whatsappUrl = `https://wa.me/55${phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');
}

async function updateReminderStatus(bookingId) {
  try {
    // Atualizar no Firebase
    await db.collection('bookings').doc(bookingId).update({
      reminderSent: true,
      reminderSentAt: new Date()
    });
    
    // Atualizar no cache local
    const bookingIndex = cache.bookings.findIndex(b => b.id === bookingId);
    if (bookingIndex !== -1) {
      cache.bookings[bookingIndex].reminderSent = true;
      cache.bookings[bookingIndex].reminderSentAt = new Date();
    }
    
    console.log("Status do lembrete atualizado com sucesso");
  } catch (error) {
    console.error("Erro ao atualizar status do lembrete:", error);
    showToast("Erro ao marcar lembrete como enviado.", "error");
  }
}
        // Função para gerar arquivo ICS com os agendamentos
function generateICSFile() {
  const bookings = cache.bookings.filter(b => b.status === 'confirmed');
  let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//PsiPro//Agendamentos//PT
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Agendamentos PsiPro
X-WR-TIMEZONE:America/Sao_Paulo
`;

  bookings.forEach(booking => {
    const startDate = new Date(`${booking.date}T${booking.time}:00`);
    const endDate = new Date(startDate);
    endDate.setMinutes(endDate.getMinutes() + (state.settings?.sessionDuration || 50));
    
    // Formatar datas no formato necessário pelo ICS
    const formatDate = (date) => {
      return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
    };
    
    icsContent += `
BEGIN:VEVENT
UID:${booking.id}@psipro
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '')}
DTSTART:${formatDate(startDate)}
DTEND:${formatDate(endDate)}
SUMMARY:Sessão com ${booking.clientName}
DESCRIPTION:Valor: R$ ${booking.value}\\nTelefone: ${booking.clientPhone}\\n${booking.clientEmail ? `Email: ${booking.clientEmail}\\n` : ''}Origem: ${booking.clientSource}
LOCATION:Atendimento Online
END:VEVENT
`;
  });

  icsContent += `END:VCALENDAR`;
  
  // Criar arquivo para download
  const blob = new Blob([icsContent], { type: 'text/calendar' });
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = `agendamentos_psipro_${new Date().toISOString().split('T')[0]}.ics`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  showToast("Arquivo .ics gerado com sucesso! Importe no seu Google Calendar.");
}

// Tornar a função acessível globalmente
window.generateICSFile = generateICSFile;
        // Tornar funções acessíveis globalmente para os eventos onclick do HTML
window.sendQuickMsg = sendQuickMsg;
window.sendMessage = sendMessage;
window.closeModal = closeModal;
        
        // Keyboard shortcuts for desktop
        document.addEventListener('keydown', (e) => {
            // ESC to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.classList.add('hidden');
                });
            }
        
            // Ctrl + B to open booking modal from client view
            if (e.ctrlKey && e.key === 'b' && state.view !== 'view-admin') {
                openBookingModal();
            }
        
            // Ctrl + D to navigate to dashboard
            if (e.ctrlKey && e.key === 'd' && state.view === 'view-admin') {
                switchTab('dashboard');
            }
        });
        // --- SISTEMA DE TRANSCRIÇÃO E IA (CUSTO ZERO) ---

// Configuração da IA (Gemini Flash - Free Tier)
const GEMINI_API_KEY = "COLE_SUA_API_KEY_DO_GOOGLE_AI_STUDIO_AQUI"; 

let recognition = null;
let isRecording = false;

// Inicializa o reconhecimento de fala do navegador
function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true; // Continua gravando mesmo com pausas
        recognition.interimResults = true; // Mostra o texto enquanto fala
        recognition.lang = 'pt-BR';

        recognition.onstart = function() {
            isRecording = true;
            document.getElementById('record-text').innerText = "Parar Gravação";
            document.getElementById('btn-record').classList.remove('bg-red-50', 'text-red-600');
            document.getElementById('btn-record').classList.add('bg-red-600', 'text-white', 'animate-pulse');
        };

        recognition.onend = function() {
            isRecording = false;
            document.getElementById('record-text').innerText = "Gravar Áudio";
            document.getElementById('btn-record').classList.add('bg-red-50', 'text-red-600');
            document.getElementById('btn-record').classList.remove('bg-red-600', 'text-white', 'animate-pulse');
        };

        recognition.onresult = function(event) {
            let finalTranscript = '';
            let interimTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }

            // Inserir no textarea
            const textarea = document.getElementById('client-notes-area');
            // Nota: Em uma implementação real, precisa cuidar para não sobrescrever texto antigo se editar no meio
            // Aqui estamos apenas anexando ao final para simplificar
            if (finalTranscript) {
                textarea.value += finalTranscript + ' ';
            }
        };
    } else {
        showToast("Seu navegador não suporta transcrição de áudio nativa.", "error");
    }
}

function toggleRecording() {
    if (!recognition) initSpeechRecognition();
    
    if (isRecording) {
        recognition.stop();
    } else {
        recognition.start();
    }
}

async function generateSmartSummary() {
    const textarea = document.getElementById('client-notes-area');
    const rawText = textarea.value.trim();

    if (!rawText) {
        showToast("Não há texto para processar.", "error");
        return;
    }
    
    if (!GEMINI_API_KEY || GEMINI_API_KEY === "COLE_SUA_API_KEY_DO_GOOGLE_AI_STUDIO_AQUI") {
        showToast("Configure a API Key no código para usar a IA.", "error");
        return;
    }

    showLoader(true);
    showToast("A Inteligência Artificial está organizando suas anotações...");

    try {
        // Prompt para estruturar como prontuário psicológico
        const prompt = `
            Aja como um assistente de psicólogo experiente. 
            Analise o seguinte texto bruto (que pode conter erros de transcrição de áudio) de uma sessão de terapia.
            Organize as informações em um formato clínico padrão (SOAP ou DAP), corrigindo a gramática e removendo vícios de linguagem.
            
            Estrutura desejada:
            1. **Dados Subjetivos (O que o paciente disse/sentiu)**
            2. **Dados Objetivos (Observações do terapeuta)**
            3. **Avaliação (Análise clínica)**
            4. **Plano (Próximos passos/Tarefas)**
            
            Texto bruto:
            "${rawText}"
        `;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${AIzaSyAEVbiuzA90teoVxu53_FKAWaKyj5kiCZc}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: prompt }]
                }]
            })
        });

        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error.message);
        }

        const aiText = data.candidates[0].content.parts[0].text;
        
        // Substituir o texto ou adicionar? Vamos adicionar um separador.
        textarea.value = `--- TEXTO ORIGINAL ---\n${rawText}\n\n--- REGISTRO INTELIGENTE (IA) ---\n${aiText}`;
        
        showToast("Registro inteligente gerado com sucesso!");

    } catch (error) {
        console.error("Erro na IA:", error);
        showToast("Erro ao conectar com a IA. Verifique a chave ou conexão.", "error");
    } finally {
        showLoader(false);
    }
}
        // Final initialization
        console.log("PsiPro initialized successfully!");
    </script>
</body>
</html>
